if(!this.uuid){uuid=require("../uuid")}function _log(b,f){f=f||"log";if(typeof(document)!="undefined"){document.write('<div class="'+f+'">'+b.replace(/\n/g,"<br />")+"</div>")}if(typeof(console)!="undefined"){var a={log:"\033[39m",warn:"\033[33m",error:"\033[31m"};console[f](a[f]+b+a.log)}}function log(a){_log(a,"log")}function warn(a){_log(a,"warn")}function error(a){_log(a,"error")}function assert(b,a){if(!b){error("FAIL: "+a)}else{log("Pass: "+a)}}var TIME=1321644961388;function compare(b,a){a=a.map(function(g){return g.split("-").reverse().join("-")}).sort();var f=([].concat(a)).sort();assert(f.toString()==a.toString(),b+" have expected order")}compare("uuids with current time",[uuid.v1(),uuid.v1(),uuid.v1(),uuid.v1(),uuid.v1()]);compare("uuids with time option",[uuid.v1({msecs:TIME-10*3600*1000}),uuid.v1({msecs:TIME-1}),uuid.v1({msecs:TIME}),uuid.v1({msecs:TIME+1}),uuid.v1({msecs:TIME+28*24*3600*1000}),]);assert(uuid.v1({msecs:TIME})!=uuid.v1({msecs:TIME}),"IDs created at same msec are different");var thrown=false;try{uuid.v1({msecs:TIME,nsecs:10000})}catch(e){thrown=true}assert(thrown,"Exception thrown when > 10K ids created in 1 ms");var uidt=uuid.v1({msecs:TIME});var uidtb=uuid.v1({msecs:TIME-1});assert(parseInt(uidtb.split("-")[3],16)-parseInt(uidt.split("-")[3],16)===1,"Clock regression by msec increments the clockseq");var uidtn=uuid.v1({msecs:TIME,nsecs:10});var uidtnb=uuid.v1({msecs:TIME,nsecs:9});assert(parseInt(uidtnb.split("-")[3],16)-parseInt(uidtn.split("-")[3],16)===1,"Clock regression by nsec increments the clockseq");var id=uuid.v1({msecs:1321651533573,nsecs:5432,clockseq:14428,node:[97,205,60,187,50,16]});assert(id=="d9428888-122b-11e1-b85c-61cd3cbb3210","Explicit options produce expected id");var u0=uuid.v1({msecs:TIME,nsecs:9999});var u1=uuid.v1({msecs:TIME+1,nsecs:0});var before=u0.split("-")[0],after=u1.split("-")[0];var dt=parseInt(after,16)-parseInt(before,16);assert(dt===1,"Ids spanning 1ms boundary are 100ns apart");id="00112233445566778899aabbccddeeff";assert(uuid.unparse(uuid.parse(id.substr(0,10)))=="00112233-4400-0000-0000-000000000000","Short parse");assert(uuid.unparse(uuid.parse("(this is the uuid -> "+id+id))=="00112233-4455-6677-8899-aabbccddeeff","Dirty parse");var generators={v1:uuid.v1,v4:uuid.v4};var UUID_FORMAT={v1:/[0-9a-f]{8}-[0-9a-f]{4}-1[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/i,v4:/[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/i};var N=10000;function divergence(a,b){return Math.round(100*100*(a-b)/b)/100}function rate(a,b){log(a+": "+(N/(Date.now()-b)*1000|0)+" uuids/second")}for(var version in generators){var counts={},max=0;var generator=generators[version];var format=UUID_FORMAT[version];log("\nSanity check "+N+" "+version+" uuids");for(var i=0,ok=0;i<N;i++){id=generator();if(!format.test(id)){throw Error(id+" is not a valid UUID string")}if(id!=uuid.unparse(uuid.parse(id))){assert(fail,id+" is not a valid id")}if(version=="v4"){var digits=id.replace(/-/g,"").split("");for(var j=digits.length-1;j>=0;j--){var c=digits[j];max=Math.max(max,counts[c]=(counts[c]||0)+1)}}}if(version=="v4"){var limit=2*100*Math.sqrt(1/N);log("\nChecking v4 randomness.  Distribution of Hex Digits (% deviation from ideal)");for(var i=0;i<16;i++){var c=i.toString(16);var bar="",n=counts[c],p=Math.round(n/max*100|0);var ideal=N*30/16;if(i==4){ideal=N*(1+30/16)}else{if(i>=8&&i<=11){ideal=N*(1/4+30/16)}else{ideal=N*30/16}}var d=divergence(n,ideal);var s=n/max*50|0;while(s--){bar+="="}assert(Math.abs(d)<limit,c+" |"+bar+"| "+counts[c]+" ("+d+"% < "+limit+"%)")}}}for(var version in generators){log("\nPerformance testing "+version+" UUIDs");var generator=generators[version];var buf=new uuid.BufferClass(16);if(version=="v4"){["mathRNG","whatwgRNG","nodeRNG"].forEach(function(f){if(uuid[f]){var b={rng:uuid[f]};for(var a=0,g=Date.now();a<N;a++){generator(b)}rate("uuid."+version+"() with "+f,g)}else{log("uuid."+version+"() with "+f+": not defined")}})}else{for(var i=0,t=Date.now();i<N;i++){generator()}rate("uuid."+version+"()",t)}for(var i=0,t=Date.now();i<N;i++){generator("binary")}rate("uuid."+version+"('binary')",t);for(var i=0,t=Date.now();i<N;i++){generator("binary",buf)}rate("uuid."+version+"('binary', buffer)",t)};