if(typeof window==="undefined"){var Buffer=require("buffer").Buffer;var bson=require("./bson")}var BSON_BINARY_SUBTYPE_DEFAULT=0;var writeStringToArray=function(b){var a=typeof Uint8Array!="undefined"?new Uint8Array(new ArrayBuffer(b.length)):new Array(b.length);for(var c=0;c<b.length;c++){a[c]=b.charCodeAt(c)}return a};var convertArraytoUtf8BinaryString=function(a,e,b){var d="";for(var c=e;c<b;c++){d=d+String.fromCharCode(a[c])}return d};function Binary(a,b){if(!(this instanceof Binary)){return new Binary(a,b)}this._bsontype="Binary";if(a instanceof Number){this.sub_type=a;this.position=0}else{this.sub_type=b==null?BSON_BINARY_SUBTYPE_DEFAULT:b;this.position=0}if(a!=null&&!(a instanceof Number)){if(typeof a=="string"){if(typeof Buffer!="undefined"){this.buffer=new Buffer(a)}else{if(typeof Uint8Array!="undefined"||(Object.prototype.toString.call(a)=="[object Array]")){this.buffer=writeStringToArray(a)}else{throw new Error("only String, Buffer, Uint8Array or Array accepted")}}}else{this.buffer=a}this.position=a.length}else{if(typeof Buffer!="undefined"){this.buffer=new Buffer(Binary.BUFFER_SIZE)}else{if(typeof Uint8Array!="undefined"){this.buffer=new Uint8Array(new ArrayBuffer(Binary.BUFFER_SIZE))}else{this.buffer=new Array(Binary.BUFFER_SIZE)}}this.position=0}}Binary.prototype.put=function put(b){if(b.length!=null&&typeof b!="number"&&b.length!=1){throw new Error("only accepts single character String, Uint8Array or Array")}if(typeof b!="number"&&b<0||b>255){throw new Error("only accepts number in a valid unsigned byte range 0-255")}var c=null;if(typeof b=="string"){c=b.charCodeAt(0)}else{if(b.length!=null){c=b[0]}else{c=b}}if(this.buffer.length>this.position){this.buffer[this.position++]=c}else{if(typeof Buffer!="undefined"&&Buffer.isBuffer(this.buffer)){var a=new Buffer(Binary.BUFFER_SIZE+this.buffer.length);this.buffer.copy(a,0,0,this.buffer.length);this.buffer=a;this.buffer[this.position++]=c}else{var a=null;if(Object.prototype.toString.call(this.buffer)=="[object Uint8Array]"){a=new Uint8Array(new ArrayBuffer(Binary.BUFFER_SIZE+this.buffer.length))}else{a=new Array(Binary.BUFFER_SIZE+this.buffer.length)}for(var d=0;d<this.buffer.length;d++){a[d]=this.buffer[d]}this.buffer=a;this.buffer[this.position++]=c}}};Binary.prototype.write=function write(d,c){c=typeof c=="number"?c:this.position;if(this.buffer.length<c+d.length){var a=null;if(typeof Buffer!="undefined"&&Buffer.isBuffer(this.buffer)){a=new Buffer(this.buffer.length+d.length);this.buffer.copy(a,0,0,this.buffer.length)}else{if(Object.prototype.toString.call(this.buffer)=="[object Uint8Array]"){a=new Uint8Array(new ArrayBuffer(this.buffer.length+d.length));for(var b=0;b<this.position;b++){a[b]=this.buffer[b]}}}this.buffer=a}if(typeof Buffer!="undefined"&&Buffer.isBuffer(d)&&Buffer.isBuffer(this.buffer)){d.copy(this.buffer,c,0,d.length);this.position=(c+d.length)>this.position?(c+d.length):this.position}else{if(typeof Buffer!="undefined"&&typeof d=="string"&&Buffer.isBuffer(this.buffer)){this.buffer.write(d,"binary",c);this.position=(c+d.length)>this.position?(c+d.length):this.position}else{if(Object.prototype.toString.call(d)=="[object Uint8Array]"||Object.prototype.toString.call(d)=="[object Array]"&&typeof d!="string"){for(var b=0;b<d.length;b++){this.buffer[c++]=d[b]}this.position=c>this.position?c:this.position}else{if(typeof d=="string"){for(var b=0;b<d.length;b++){this.buffer[c++]=d.charCodeAt(b)}this.position=c>this.position?c:this.position}}}}};Binary.prototype.read=function read(d,c){c=c&&c>0?c:this.position;if(this.buffer.slice){return this.buffer.slice(d,d+c)}else{var a=typeof Uint8Array!="undefined"?new Uint8Array(new ArrayBuffer(c)):new Array(c);for(var b=0;b<c;b++){a[b]=this.buffer[d++]}}return a};Binary.prototype.value=function value(a){a=a==null?false:a;if(typeof Buffer!="undefined"&&Buffer.isBuffer(this.buffer)){return a?this.buffer.slice(0,this.position):this.buffer.toString("binary",0,this.position)}else{if(a){if(this.buffer.slice!=null){return this.buffer.slice(0,this.position)}else{var c=Object.prototype.toString.call(this.buffer)=="[object Uint8Array]"?new Uint8Array(new ArrayBuffer(this.position)):new Array(this.position);for(var b=0;b<this.position;b++){c[b]=this.buffer[b]}return c}}else{return convertArraytoUtf8BinaryString(this.buffer,0,this.position)}}};Binary.prototype.length=function length(){return this.position};Binary.prototype.toJSON=function(){return this.buffer!=null?this.buffer.toString("base64"):""};Binary.prototype.toString=function(a){return this.buffer!=null?this.buffer.slice(0,this.position).toString(a):""};Binary.BUFFER_SIZE=256;Binary.SUBTYPE_DEFAULT=0;Binary.SUBTYPE_FUNCTION=1;Binary.SUBTYPE_BYTE_ARRAY=2;Binary.SUBTYPE_UUID=3;Binary.SUBTYPE_MD5=4;Binary.SUBTYPE_USER_DEFINED=128;if(typeof window==="undefined"){exports.Binary=Binary};