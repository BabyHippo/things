var utils=require("./connection_utils"),inherits=require("util").inherits,net=require("net"),EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,binaryutils=require("../utils"),tls=require("tls");var Connection=exports.Connection=function(a,b){EventEmitter.call(this);this.socketOptions=b?b:{host:"localhost",port:27017};this.id=a;this.connected=false;this.maxBsonSize=b.maxBsonSize?b.maxBsonSize:Connection.DEFAULT_MAX_BSON_SIZE;this.buffer=null;this.sizeOfMessage=0;this.bytesRead=0;this.stubBuffer=0;this.eventHandlers={error:[],parseError:[],poolReady:[],message:[],close:[],timeout:[],end:[]};resetHandlers(this,false)};Connection.DEFAULT_MAX_BSON_SIZE=1024*1024*4;inherits(Connection,EventEmitter);Connection.prototype.start=function(){if(this.socketOptions.ssl){this.connection=new net.Socket();this.connection.setTimeout(this.socketOptions.connectTimeoutMS!=null?this.socketOptions.connectTimeoutMS:this.socketOptions.timeout);if(process.version.indexOf("v0.4")==-1){this.connection.setNoDelay(this.socketOptions.noDelay)}if(process.version.indexOf("v0.4")==-1){if(this.socketOptions.keepAlive>0){this.connection.setKeepAlive(true,this.socketOptions.keepAlive)}else{this.connection.setKeepAlive(false)}}var a=this.pair=tls.createSecurePair(false);this.pair.encrypted.pipe(this.connection);this.connection.pipe(this.pair.encrypted);this.writeSteam=this.pair.cleartext;this.pair.on("secure",connectHandler(this));this.pair.cleartext.on("data",createDataHandler(this));this.connection.on("error",errorHandler(this));this.connection.on("end",endHandler(this));this.connection.on("timeout",timeoutHandler(this));this.connection.on("drain",drainHandler(this));this.writeSteam.on("close",closeHandler(this));this.connection.connect(this.socketOptions.port,this.socketOptions.host)}else{this.connection=net.createConnection(this.socketOptions.port,this.socketOptions.host);this.connection.setTimeout(this.socketOptions.connectTimeoutMS!=null?this.socketOptions.connectTimeoutMS:this.socketOptions.timeout);if(process.version.indexOf("v0.4")==-1){this.connection.setNoDelay(this.socketOptions.noDelay)}if(process.version.indexOf("v0.4")==-1){if(this.socketOptions.keepAlive>0){this.connection.setKeepAlive(true,this.socketOptions.keepAlive)}else{this.connection.setKeepAlive(false)}}this.writeSteam=this.connection;this.connection.on("error",errorHandler(this));this.connection.on("connect",connectHandler(this));this.connection.on("data",createDataHandler(this));this.connection.on("timeout",timeoutHandler(this));this.connection.on("drain",drainHandler(this));this.connection.on("close",closeHandler(this))}};Connection.prototype.isConnected=function(){return this.connected&&!this.connection.destroyed&&this.connection.writable&&this.connection.readable};Connection.prototype.write=function(c,b){try{if(Array.isArray(c)){for(var e=0;e<c.length;e++){var a=c[e].toBinary();if(!this.socketOptions.disableDriverBSONSizeCheck&&a.length>this.maxBsonSize){return b(new Error("Document exceeds maximal allowed bson size of "+this.maxBsonSize+" bytes"))}if(this.logger!=null&&this.logger.doDebug){this.logger.debug("writing command to mongodb",a)}var f=this.writeSteam.write(a)}}else{var a=c.toBinary();if(!this.socketOptions.disableDriverBSONSizeCheck&&a.length>this.maxBsonSize){return b(new Error("Document exceeds maximal allowed bson size of "+this.maxBsonSize+" bytes"))}if(this.logger!=null&&this.logger.doDebug){this.logger.debug("writing command to mongodb",a)}var f=this.writeSteam.write(a)}}catch(d){if(typeof b==="function"){b(d)}}};Connection.prototype.close=function(){resetHandlers(this,true);this.connection.on("error",function(){});this.connection.destroy()};var resetHandlers=function(d,a){d.eventHandlers={error:[],connect:[],close:[],end:[],timeout:[],parseError:[],message:[]};if(a&&d.connection!=null){var c=Object.keys(d.eventHandlers);for(var b=0;b<c.length;b++){d.connection.removeAllListeners(c[b])}}};var connectHandler=function(a){return function(){a.connected=true;a.connection.setTimeout(a.socketOptions.socketTimeoutMS!=null?a.socketOptions.socketTimeoutMS:a.socketOptions.timeout);a.emit("connect",null,a)}};var createDataHandler=exports.Connection.createDataHandler=function(a){return function(b){while(b.length>0){if(a.bytesRead>0&&a.sizeOfMessage>0){var h=a.sizeOfMessage-a.bytesRead;if(h>b.length){b.copy(a.buffer,a.bytesRead);a.bytesRead=a.bytesRead+b.length;b=new Buffer(0)}else{b.copy(a.buffer,a.bytesRead,0,h);b=b.slice(h);try{var c=a.buffer;a.buffer=null;a.sizeOfMessage=0;a.bytesRead=0;a.stubBuffer=null;a.emit("message",c,a)}catch(d){var e={err:"socketHandler",trace:d,bin:buffer,parseState:{sizeOfMessage:a.sizeOfMessage,bytesRead:a.bytesRead,stubBuffer:a.stubBuffer}};if(a.logger!=null&&a.logger.doError){a.logger.error("parseError",e)}a.emit("parseError",e,a)}}}else{if(a.stubBuffer!=null&&a.stubBuffer.length>0){if(a.stubBuffer.length+b.length>4){var f=new Buffer(a.stubBuffer.length+b.length);a.stubBuffer.copy(f,0);b.copy(f,a.stubBuffer.length);b=f;a.buffer=null;a.sizeOfMessage=0;a.bytesRead=0;a.stubBuffer=null}else{var g=new Buffer(a.stubBuffer.length+b.length);a.stubBuffer.copy(g,0);b.copy(g,a.stubBuffer.length);b=new Buffer(0)}}else{if(b.length>4){var i=binaryutils.decodeUInt32(b,0);if(i<0||i>a.maxBsonSize){var e={err:"socketHandler",trace:"",bin:a.buffer,parseState:{sizeOfMessage:i,bytesRead:a.bytesRead,stubBuffer:a.stubBuffer}};if(a.logger!=null&&a.logger.doError){a.logger.error("parseError",e)}a.emit("parseError",e,a);return}if(i>4&&i<a.maxBsonSize&&i>b.length){a.buffer=new Buffer(i);b.copy(a.buffer,0);a.bytesRead=b.length;a.sizeOfMessage=i;a.stubBuffer=null;b=new Buffer(0)}else{if(i>4&&i<a.maxBsonSize&&i==b.length){try{var c=b;a.buffer=null;a.sizeOfMessage=0;a.bytesRead=0;a.stubBuffer=null;b=new Buffer(0);a.emit("message",c,a)}catch(d){var e={err:"socketHandler",trace:d,bin:a.buffer,parseState:{sizeOfMessage:a.sizeOfMessage,bytesRead:a.bytesRead,stubBuffer:a.stubBuffer}};if(a.logger!=null&&a.logger.doError){a.logger.error("parseError",e)}a.emit("parseError",e,a)}}else{if(i<=4||i>a.maxBsonSize){var e={err:"socketHandler",trace:null,bin:b,parseState:{sizeOfMessage:i,bytesRead:0,buffer:null,stubBuffer:null}};if(a.logger!=null&&a.logger.doError){a.logger.error("parseError",e)}a.emit("parseError",e,a);a.buffer=null;a.sizeOfMessage=0;a.bytesRead=0;a.stubBuffer=null;b=new Buffer(0)}else{try{var c=b.slice(0,i);a.buffer=null;a.sizeOfMessage=0;a.bytesRead=0;a.stubBuffer=null;b=b.slice(i);a.emit("message",c,a)}catch(d){var e={err:"socketHandler",trace:d,bin:a.buffer,parseState:{sizeOfMessage:i,bytesRead:a.bytesRead,stubBuffer:a.stubBuffer}};if(a.logger!=null&&a.logger.doError){a.logger.error("parseError",e)}a.emit("parseError",e,a)}}}}}else{a.stubBuffer=new Buffer(b.length);b.copy(a.stubBuffer,0);b=new Buffer(0)}}}}}};var endHandler=function(a){return function(){a.connected=false;a.emit("end",{err:"connection received Fin packet from ["+a.socketOptions.host+":"+a.socketOptions.port+"]"},a)}};var timeoutHandler=function(a){return function(){a.emit("timeout",{err:"connection to ["+a.socketOptions.host+":"+a.socketOptions.port+"] timed out"},a)}};var drainHandler=function(a){return function(){}};var errorHandler=function(a){return function(b){a.connected=false;a.emit("error",{err:"failed to connect to ["+a.socketOptions.host+":"+a.socketOptions.port+"]"},a)}};var closeHandler=function(a){return function(b){if(b&&!a.connected){a.connected=false;a.emit("error",{err:"failed to connect to ["+a.socketOptions.host+":"+a.socketOptions.port+"]"},a)}else{a.connected=false;a.emit("close",{err:"connection closed to ["+a.socketOptions.host+":"+a.socketOptions.port+"]"},a)}}};Connection.DEFAULT_PORT=27017;