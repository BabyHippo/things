var Connection=require("./connection").Connection,ReadPreference=require("./read_preference").ReadPreference,DbCommand=require("../commands/db_command").DbCommand,MongoReply=require("../responses/mongo_reply").MongoReply,ConnectionPool=require("./connection_pool").ConnectionPool,EventEmitter=require("events").EventEmitter,inherits=require("util").inherits;function Server(a,c,b){EventEmitter.call(this);if(!(this instanceof Server)){return new Server(a,c,b)}var e=this;this.host=a;this.port=c;this.options=b==null?{}:b;this.internalConnection;this.internalMaster=false;this.connected=false;this.poolSize=this.options.poolSize==null?5:this.options.poolSize;this.disableDriverBSONSizeCheck=this.options.disableDriverBSONSizeCheck!=null?this.options.disableDriverBSONSizeCheck:false;this.ssl=this.options.ssl==null?false:this.options.ssl;this.slaveOk=this.options.slave_ok;this._used=false;var d=this.options.readPreference;if(d!=null){if(d!=ReadPreference.PRIMARY&&d!=ReadPreference.SECONDARY&&d!=ReadPreference.SECONDARY_PREFERRED){throw new Error("Illegal readPreference mode specified, "+d)}this._readPreference=d}else{this._readPreference=null}this.isMasterDoc;this.socketOptions=this.options.socketOptions!=null?this.options.socketOptions:{};if(this.disableDriverBSONSizeCheck){this.socketOptions.disableDriverBSONSizeCheck=this.disableDriverBSONSizeCheck}if(this.ssl){this.socketOptions.ssl=true}this.logger=this.options.logger!=null&&(typeof this.options.logger.debug=="function")&&(typeof this.options.logger.error=="function")&&(typeof this.options.logger.log=="function")?this.options.logger:{error:function(f,g){},log:function(f,g){},debug:function(f,g){}};this.eventHandlers={error:[],parseError:[],poolReady:[],message:[],close:[],timeout:[]};this._serverState="disconnected";this._state={runtimeStats:{queryStats:new RunningStats()}};this.recordQueryStats=false}inherits(Server,EventEmitter);Server.READ_PRIMARY=ReadPreference.PRIMARY;Server.READ_SECONDARY=ReadPreference.SECONDARY_PREFERRED;Server.READ_SECONDARY_ONLY=ReadPreference.SECONDARY;Server.prototype.setReadPreference=function(){};Server.prototype.isMongos=function(){return this.isMasterDoc!=null&&this.isMasterDoc.msg=="isdbgrid"?true:false};Server.prototype._isUsed=function(){return this._used};Server.prototype.close=function(a){this.removeAllListeners();if(this.connectionPool!=null){this.connectionPool.removeAllEventListeners();this.connectionPool.stop(true)}this._serverState="disconnected";if(typeof a==="function"){a()}};Server.prototype.isConnected=function(){return this._serverState=="connected"};Server.prototype.allServerInstances=function(){return[this]};Server.prototype.isSetMember=function(){return this["replicasetInstance"]!=null||this["mongosInstance"]!=null};Server.prototype.connect=function(e,g,a){if("function"===typeof g){a=g,g={}}if(g==null){g={}}if(!("function"===typeof a)){a=null}if(this.ssl==true){this.socketOptions.ssl=true}var i=this;var f=g.eventReceiver!=null?g.eventReceiver:this;this.dbInstance=e;this.dbInstances=[e];if(i.connectionPool){i.connectionPool.stop()}this._serverState="connecting";e.slaveOk=this.slaveOk?this.slaveOk:e.slaveOk;var d=new ConnectionPool(this.host,this.port,this.poolSize,e.bson,this.socketOptions);d.logger=this.logger;i.connectionPool=d;var h=g.returnIsMasterResults==null?false:g.returnIsMasterResults;var b=function(j,l){var k=a;a=null;if(j!=null&&k==null){return}if(j!=null){return k(j,null)}i.master=l.documents[0].ismaster==1?true:false;i.connectionPool.setMaxBsonSize(l.documents[0].maxBsonObjectSize);i.connected=true;i.isMasterDoc=l.documents[0];_emitAcrossAllDbInstances(i,f,"open",null,h?l:e,null);if(h){k(null,l,i)}else{k(null,e,i)}};var c=g.connectHandler==null?b:g.connectHandler;d.on("poolReady",function(){var k=DbCommand.NcreateIsMasterCommand(e,e.databaseName);var j=d.checkoutConnection();i._serverState="connected";e._registerHandler(k,false,j,c);j.write(k)});d.on("message",function(q){try{var r=new MongoReply();r.parseHeader(q,d.bson);if(r.messageLength!=q.length){if(f.listeners("error")&&f.listeners("error").length>0){f.emit("error",new Error("bson length is different from message length"),i)}i.removeAllListeners()}else{var t=new Date().getTime();var j=null;var l=null;for(var p=0;p<i.dbInstances.length;p++){var m=i.dbInstances[p];var o=m._hasHandler(r.responseTo.toString());if(o&&j==null){j=m._findHandler(r.responseTo.toString());l=m}else{if(o){m._removeHandler(r.responseTo.toString())}}}if(j.callback&&Array.isArray(j.info.chained)){var k=j.info.chained;var s=0;for(var p=0;p<k.length;p++){if(l._hasHandler(k[p])){s++}}if(s!=k.length){for(var p=0;p<k.length;p++){l._removeHandler(k[p])}return}r.parseBody(q,d.bson,j.info.raw,function(w){if(w!=null){if(i._serverState==="disconnected"){return}i._serverState="disconnected";i.removeAllListeners();d.stop(true);if(typeof a==="function"){var A=a;a=null;A(new Error("connection closed due to parseError"),null,i)}else{if(i.isSetMember()){if(i.listeners("parseError")&&i.listeners("parseError").length>0){i.emit("parseError",new Error("connection closed due to parseError"),i)}}else{if(f.listeners("parseError")&&f.listeners("parseError").length>0){f.emit("parseError",new Error("connection closed due to parseError"),i)}}}if(!i.isSetMember()){_fireCallbackErrors(i,new Error("connection closed due to parseError"));_emitAcrossAllDbInstances(i,f,"parseError",i,null,true)}return}var u=l._findHandler(r.responseTo.toString());var x=r&&r.documents;if(x[0].err!=null||x[0].errmsg!=null){l._callHandler(r.responseTo,r,null)}else{var v=u.info.chained;if(v.length>0&&v[v.length-1]==r.responseTo){v.pop();for(var z=0;z<v.length;z++){l._removeHandler(v[z])}l._callHandler(r.responseTo,u.info.results.shift(),null)}else{for(var z=0;z<v.length;z++){var y=l._findHandler(v[z]);if(y.info!=null){y.info.results=Array.isArray(u.info.results)?u.info.results:[];y.info.results.push(r)}}}}})}else{if(j.callback){r.parseBody(q,d.bson,j.info.raw,function(u){if(u!=null){if(i._serverState==="disconnected"){return}i._serverState="disconnected";i.removeAllListeners();d.stop(true);if(typeof a==="function"){var v=a;a=null;v(new Error("connection closed due to parseError"),null,i)}else{if(i.isSetMember()){if(i.listeners("parseError")&&i.listeners("parseError").length>0){i.emit("parseError",new Error("connection closed due to parseError"),i)}}else{if(f.listeners("parseError")&&f.listeners("parseError").length>0){f.emit("parseError",new Error("connection closed due to parseError"),i)}}}if(!i.isSetMember()){_fireCallbackErrors(i,new Error("connection closed due to parseError"));_emitAcrossAllDbInstances(i,f,"parseError",i,null,true)}return}if(i.recordQueryStats==true&&i._state.runtimeStats!=null&&i._state.runtimeStats.queryStats instanceof RunningStats){i._state.runtimeStats.queryStats.push(new Date().getTime()-j.info.start)}l._callHandler(r.responseTo,r,null)})}}}}catch(n){process.nextTick(function(){throw n})}});d.on("timeout",function(j){if(i._serverState==="disconnected"){return}i._serverState="disconnected";if(typeof a==="function"){var k=a;a=null;k(j,null,i)}else{if(i.isSetMember()){if(i.listeners("timeout")&&i.listeners("timeout").length>0){i.emit("timeout",j,i)}}else{if(f.listeners("timeout")&&f.listeners("timeout").length>0){f.emit("timeout",j,i)}}}if(!i.isSetMember()){_fireCallbackErrors(i,j);_emitAcrossAllDbInstances(i,f,"timeout",j,i,true)}});d.on("error",function(k){if(i._serverState==="disconnected"){return}i._serverState="disconnected";if(typeof a==="function"){var j=a;a=null;j(new Error(k&&k.err?k.err:k),null,i)}else{if(i.isSetMember()){if(i.listeners("error")&&i.listeners("error").length>0){i.emit("error",new Error(k&&k.err?k.err:k),i)}}else{if(f.listeners("error")&&f.listeners("error").length>0){f.emit("error",new Error(k&&k.err?k.err:k),i)}}}if(!i.isSetMember()){_fireCallbackErrors(i,new Error(k&&k.err?k.err:k));_emitAcrossAllDbInstances(i,f,"error",new Error(k&&k.err?k.err:k),i,true)}});d.on("close",function(){if(i._serverState==="disconnected"){return}i._serverState="disconnected";if(typeof a=="function"){var j=a;a=null;j(new Error("connection closed"),null,i)}else{if(i.isSetMember()){if(i.listeners("close")&&i.listeners("close").length>0){i.emit("close",new Error("connection closed"),i)}}else{if(f.listeners("close")&&f.listeners("close").length>0){f.emit("close",new Error("connection closed"),i)}}}if(!i.isSetMember()){_fireCallbackErrors(i,new Error("connection closed"));_emitAcrossAllDbInstances(i,f,"close",i,null,true)}});d.on("parseError",function(k){if(i._serverState==="disconnected"){return}i._serverState="disconnected";if(typeof a==="function"){var j=a;a=null;j(new Error("connection closed due to parseError"),null,i)}else{if(i.isSetMember()){if(i.listeners("parseError")&&i.listeners("parseError").length>0){i.emit("parseError",new Error("connection closed due to parseError"),i)}}else{if(f.listeners("parseError")&&f.listeners("parseError").length>0){f.emit("parseError",new Error("connection closed due to parseError"),i)}}}if(!i.isSetMember()){_fireCallbackErrors(i,new Error("connection closed due to parseError"));_emitAcrossAllDbInstances(i,f,"parseError",i,null,true)}});d.start()};var _fireCallbackErrors=function(k,c){for(var e=0;e<k.dbInstances.length;e++){var b=k.dbInstances[e];var h=Object.keys(b._callBackStore._notReplied);for(var g=0;g<h.length;g++){var f=b._callBackStore._notReplied[h[g]];if(f&&f.chained&&Array.isArray(f.chained)&&f.chained.length>0){var a=f.chained;var d=a.pop();if(f.connection.socketOptions.host===k.host&&f.connection.socketOptions.port===k.port){b._callBackStore.emit(d,c,null)}a.push(d);for(var e=0;e<a.length;e++){delete b._callBackStore._notReplied[a[e]]}}else{if(f&&f.connection.socketOptions.host===k.host&&f.connection.socketOptions.port===k.port){b._callBackStore.emit(h[g],c,null)}}}}};var _emitAcrossAllDbInstances=function(j,d,c,f,g,h){var a=j.allServerInstances();var k=a[0];if(Array.isArray(k.dbInstances)&&k.dbInstances.length>=1){for(var e=0;e<k.dbInstances.length;e++){var b=k.dbInstances[e];if(h&&typeof b.openCalled!="undefined"){b.openCalled=false}if(d==null||d.databaseName!==b.databaseName||d.tag!==b.tag){if(b.listeners(c).length>0){b.emit(c,f,g)}}}}};Server.prototype.allRawConnections=function(){return this.connectionPool.getAllConnections()};var canCheckoutWriter=function(b,a){if(b.isMasterDoc.arbiterOnly==true){return new Error("Cannot write to an arbiter")}if(b.isMasterDoc.secondary==true){return new Error("Cannot write to a secondary")}else{if(a==true&&b._readPreference==ReadPreference.SECONDARY&&b.isMasterDoc.ismaster==true){return new Error("Cannot read from primary when secondary only specified")}}return null};Server.prototype.checkoutWriter=function(a){if(a==true){return this.connectionPool.checkoutConnection()}var b=canCheckoutWriter(this,a);if(b==null&&this.connectionPool!=null){return this.connectionPool.checkoutConnection()}else{if(b==null){return null}else{return b}}};var canCheckoutReader=function(a){if(a.isMasterDoc&&a.isMasterDoc.arbiterOnly==true){return new Error("Cannot write to an arbiter")}else{if(a._readPreference!=null){if((a._readPreference==ReadPreference.PRIMARY)&&a.isMasterDoc.ismaster!=true){return new Error("Read preference is Server.PRIMARY and server is not master")}else{if(a._readPreference==ReadPreference.SECONDARY&&a.isMasterDoc.ismaster==true){return new Error("Cannot read from primary when secondary only specified")}}}}return null};Server.prototype.checkoutReader=function(){var a=canCheckoutReader(this);if(a==null&&this.connectionPool!=null){return this.connectionPool.checkoutConnection()}else{if(a==null){return null}else{return a}}};Server.prototype.enableRecordQueryStats=function(a){this.recordQueryStats=a};var RunningStats=function(){var a=this;this.m_n=0;this.m_oldM=0;this.m_oldS=0;this.m_newM=0;this.m_newS=0;Object.defineProperty(this,"numDataValues",{enumerable:true,get:function(){return this.m_n}});Object.defineProperty(this,"mean",{enumerable:true,get:function(){return(this.m_n>0)?this.m_newM:0}});Object.defineProperty(this,"variance",{enumerable:true,get:function(){return((this.m_n>1)?this.m_newS/(this.m_n-1):0)}});Object.defineProperty(this,"standardDeviation",{enumerable:true,get:function(){return Math.sqrt(this.variance)}});Object.defineProperty(this,"sScore",{enumerable:true,get:function(){var b=this.mean+this.standardDeviation;if(b==0){return 0}return((2*this.mean*this.standardDeviation)/(b))}})};RunningStats.prototype.push=function(a){this.m_n=this.m_n+1;if(this.m_n==1){this.m_oldM=this.m_newM=a;this.m_oldS=0}else{this.m_newM=this.m_oldM+(a-this.m_oldM)/this.m_n;this.m_newS=this.m_oldS+(a-this.m_oldM)*(a-this.m_newM);this.m_oldM=this.m_newM;this.m_oldS=this.m_newS}};Object.defineProperty(Server.prototype,"autoReconnect",{enumerable:true,get:function(){return this.options.auto_reconnect==null?false:this.options.auto_reconnect}});Object.defineProperty(Server.prototype,"connection",{enumerable:true,get:function(){return this.internalConnection},set:function(a){this.internalConnection=a}});Object.defineProperty(Server.prototype,"master",{enumerable:true,get:function(){return this.internalMaster},set:function(a){this.internalMaster=a}});Object.defineProperty(Server.prototype,"primary",{enumerable:true,get:function(){return this}});Object.defineProperty(Server.prototype,"queryStats",{enumerable:true,get:function(){return this._state.runtimeStats.queryStats}});Object.defineProperty(Server.prototype,"runtimeStats",{enumerable:true,get:function(){return this._state.runtimeStats}});Object.defineProperty(Server.prototype,"readPreference",{enumerable:true,get:function(){if(this._readPreference==null&&this.readSecondary){return Server.READ_SECONDARY}else{if(this._readPreference==null&&!this.readSecondary){return Server.READ_PRIMARY}else{return this._readPreference}}}});exports.Server=Server;