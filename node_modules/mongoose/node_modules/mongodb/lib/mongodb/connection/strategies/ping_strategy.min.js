var Server=require("../server").Server;var PingStrategy=exports.PingStrategy=function(a,b){this.replicaset=a;this.secondaryAcceptableLatencyMS=b;this.state="disconnected";this.Db=require("../../db").Db};PingStrategy.prototype.start=function(a){this.state="connected";this._pingServer(a)};PingStrategy.prototype.stop=function(a){this.state="disconnected";a(null,null)};PingStrategy.prototype.checkoutSecondary=function(o,k){var b=[];if(!Array.isArray(k)){b=this.replicaset._state.master!=null?[this.replicaset._state.master]:[];var f=Object.keys(this.replicaset._state.secondaries);for(var d=0;d<f.length;d++){b.push(this.replicaset._state.secondaries[f[d]])}}else{b=k}var c=[];if(o!=null&&typeof o=="object"){var n=Array.isArray(o)?o:[o];for(var a=0;a<n.length;a++){var m=n[a];var h=Object.keys(m);for(var d=0;d<b.length;d++){var l=b[d];if(l.tags!=null){var g=true;for(var e=0;e<h.length;e++){if(l.tags[h[e]]!=m[h[e]]){g=false;break}}if(g){c.push(l)}}}}}else{var c=b}c.sort(function(i,j){return i.runtimeStats.pingMs>j.runtimeStats.pingMs});for(var d=0;d<c.length;d++){if(c[d].runtimeStats.pingMs>c[0].runtimeStats.pingMs+this.secondaryAcceptableLatencyMS){c=c.slice(d);break}}if(c.length==0){return new Error("No replica set members available for query")}return c[Math.round(Math.random(1000000)*(c.length-1))].checkoutReader()};PingStrategy.prototype._pingServer=function(a){var c=this;var b=function(){if(c.state=="disconnected"){return}var d=c.replicaset._state!=null&&c.replicaset._state.addresses!=null?c.replicaset._state.addresses:null;var h=Object.keys(d);var f=h.length;for(var e=0;e<h.length;e++){var g=d[h[e]];new function(k){var j=new Server(k.host,k.port,{poolSize:1,timeout:500});var i=new c.Db(c.replicaset.db.databaseName,j);i.on("error",function(l){f=f-1;i.close();if(f==0&&c.state=="connected"){setTimeout(b,1000)}});i.open(function(l,m){if(l!=null){i.close()}else{var n=new Date().getTime();m.executeDbCommand({ping:1},function(p,q){f=f-1;var o=new Date().getTime();if(k!=null&&k.runtimeStats!=null&&k.isConnected()){k.runtimeStats.pingMs=(o-n)}m.close();if(f==0&&c.state=="connected"){setTimeout(b,1000)}})}})}(g)}};setTimeout(b,1000);a(null)};