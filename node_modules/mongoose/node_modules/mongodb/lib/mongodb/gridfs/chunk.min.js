var Binary=require("bson").Binary,ObjectID=require("bson").ObjectID;var Chunk=exports.Chunk=function(b,c){if(!(this instanceof Chunk)){return new Chunk(b,c)}this.file=b;var e=this;var d=c==null?{}:c;this.objectId=d._id==null?new ObjectID():d._id;this.chunkNumber=d.n==null?0:d.n;this.data=new Binary();if(d.data==null){}else{if(typeof d.data=="string"){var a=new Buffer(d.data.length);a.write(d.data,"binary",0);this.data=new Binary(a)}else{if(Array.isArray(d.data)){var a=new Buffer(d.data.length);a.write(d.data.join(""),"binary",0);this.data=new Binary(a)}else{if(d.data instanceof Binary||Object.prototype.toString.call(d.data)=="[object Binary]"){this.data=d.data}else{if(Buffer.isBuffer(d.data)){}else{throw Error("Illegal chunk format")}}}}}this.internalPosition=0};Chunk.prototype.write=function(b,a){this.data.write(b,this.internalPosition);this.internalPosition=this.data.length();if(a!=null){return a(null,this)}return this};Chunk.prototype.read=function(b){b=b==null||b==0?this.length():b;if(this.length()-this.internalPosition+1>=b){var a=this.data.read(this.internalPosition,b);this.internalPosition=this.internalPosition+b;return a}else{return""}};Chunk.prototype.readSlice=function(b){if((this.length()-this.internalPosition)>=b){var a=null;if(this.data.buffer!=null){a=this.data.buffer.slice(this.internalPosition,this.internalPosition+b)}else{a=new Buffer(b);b=this.data.readInto(a,this.internalPosition)}this.internalPosition=this.internalPosition+b;return a}else{return null}};Chunk.prototype.eof=function(){return this.internalPosition==this.length()?true:false};Chunk.prototype.getc=function(){return this.read(1)};Chunk.prototype.rewind=function(){this.internalPosition=0;this.data=new Binary()};Chunk.prototype.save=function(a){var b=this;b.file.chunkCollection(function(d,c){if(d){return a(d)}c.remove({_id:b.objectId},{safe:true},function(e,f){if(e){return a(e)}if(b.data.length()>0){b.buildMongoObject(function(g){c.insert(g,{safe:true},function(i,h){a(i,b)})})}else{a(null,b)}})})};Chunk.prototype.buildMongoObject=function(a){var b={_id:this.objectId,files_id:this.file.fileId,n:this.chunkNumber,data:this.data};a(b)};Chunk.prototype.length=function(){return this.data.length()};Object.defineProperty(Chunk.prototype,"position",{enumerable:true,get:function(){return this.internalPosition},set:function(a){this.internalPosition=a}});Chunk.DEFAULT_CHUNK_SIZE=1024*256;