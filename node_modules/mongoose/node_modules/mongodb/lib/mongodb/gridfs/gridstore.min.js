var Chunk=require("./chunk").Chunk,DbCommand=require("../commands/db_command").DbCommand,ObjectID=require("bson").ObjectID,Buffer=require("buffer").Buffer,fs=require("fs"),util=require("util"),inherits=util.inherits,ReadStream=require("./readstream").ReadStream,Stream=require("stream");var REFERENCE_BY_FILENAME=0,REFERENCE_BY_ID=1;var GridStore=function GridStore(a,c,b,d,e){if(!(this instanceof GridStore)){return new GridStore(a,c,b,d,e)}var f=this;this.db=a;Stream.call(this);if(e==null){e={}}if(d==null){d=b;b=null}else{if(typeof d=="object"){e=d;d=b;b=null}}if(c instanceof ObjectID&&(typeof b=="string"||b==null)){this.referenceBy=1;this.fileId=c;this.filename=b}else{if(!(c instanceof ObjectID)&&typeof c=="string"&&d.indexOf("w")!=null){this.referenceBy=0;this.fileId=new ObjectID();this.filename=c}else{if(!(c instanceof ObjectID)&&typeof c=="string"&&d.indexOf("r")!=null){this.referenceBy=0;this.filename=b}else{this.referenceBy=1;this.fileId=c;this.filename=b}}}this.mode=d==null?"r":d;this.options=e==null?{}:e;this.root=this.options.root==null?exports.GridStore.DEFAULT_ROOT_COLLECTION:this.options.root;this.position=0;this.internalChunkSize=this.options.chunkSize==null?Chunk.DEFAULT_CHUNK_SIZE:this.options.chunkSize;this.previousChunkSize=0};GridStore.prototype={__proto__:Stream.prototype};GridStore.prototype._pipe=GridStore.prototype.pipe;GridStore.prototype.open=function(a){if(this.mode!="w"&&this.mode!="w+"&&this.mode!="r"){a(new Error("Illegal mode "+this.mode),null);return}var b=this;if((b.mode=="w"||b.mode=="w+")&&b.db.serverConfig.primary!=null){b.collection(function(d,c){if(d){return a(d)}c.ensureIndex([["filename",1]],function(e,f){if(e){return a(e)}b.chunkCollection(function(h,g){if(h){return a(h)}g.ensureIndex([["files_id",1],["n",1]],function(i,j){if(i){return a(i)}_open(b,a)})})})})}else{_open(b,a)}};var _open=function(c,a){c.collection(function(e,d){if(e!==null){a(new Error("at collection: "+e),null);return}var f=c.referenceBy==REFERENCE_BY_ID?{_id:c.fileId}:{filename:c.filename};f=null==c.fileId&&this.filename==null?null:f;if(f!=null){d.find(f,function(h,g){if(h){return b(h)}g.nextObject(function(j,i){if(j){return b(j)}if(i!=null){c.fileId=i._id;c.filename=i.filename;c.contentType=i.contentType;c.internalChunkSize=i.chunkSize;c.uploadDate=i.uploadDate;c.aliases=i.aliases;c.length=i.length;c.metadata=i.metadata;c.internalMd5=i.md5}else{c.fileId=c.fileId==null?new ObjectID():c.fileId;c.contentType=exports.GridStore.DEFAULT_CONTENT_TYPE;c.internalChunkSize=c.internalChunkSize==null?Chunk.DEFAULT_CHUNK_SIZE:c.internalChunkSize;c.length=0}if(c.mode=="r"){nthChunk(c,0,function(l,k){if(l){return b(l)}c.currentChunk=k;c.position=0;a(null,c)})}else{if(c.mode=="w"){deleteChunks(c,function(k,l){if(k){return b(k)}c.currentChunk=new Chunk(c,{n:0});c.contentType=c.options.content_type==null?c.contentType:c.options.content_type;c.internalChunkSize=c.options.chunk_size==null?c.internalChunkSize:c.options.chunk_size;c.metadata=c.options.metadata==null?c.metadata:c.options.metadata;c.position=0;a(null,c)})}else{if(c.mode=="w+"){nthChunk(c,lastChunkNumber(c),function(l,k){if(l){return b(l)}c.currentChunk=k==null?new Chunk(c,{n:0}):k;c.currentChunk.position=c.currentChunk.data.length();c.metadata=c.options.metadata==null?c.metadata:c.options.metadata;c.position=c.length;a(null,c)})}}}})})}else{c.fileId=null==c.fileId?new ObjectID():c.fileId;c.contentType=exports.GridStore.DEFAULT_CONTENT_TYPE;c.internalChunkSize=c.internalChunkSize==null?Chunk.DEFAULT_CHUNK_SIZE:c.internalChunkSize;c.length=0;c.chunkCollection(function(h,g){if(h){return b(h)}if(c.mode=="w"){deleteChunks(c,function(i,j){if(i){return b(i)}c.currentChunk=new Chunk(c,{n:0});c.contentType=c.options.content_type==null?c.contentType:c.options.content_type;c.internalChunkSize=c.options.chunk_size==null?c.internalChunkSize:c.options.chunk_size;c.metadata=c.options.metadata==null?c.metadata:c.options.metadata;c.position=0;a(null,c)})}else{if(c.mode=="w+"){nthChunk(c,lastChunkNumber(c),function(j,i){if(j){return b(j)}c.currentChunk=i==null?new Chunk(c,{n:0}):i;c.currentChunk.position=c.currentChunk.data.length();c.metadata=c.options.metadata==null?c.metadata:c.options.metadata;c.position=c.length;a(null,c)})}}})}});function b(d){if(b.err){return}a(b.err=d)}};GridStore.prototype.writeFile=function(b,a){var c=this;if(typeof b==="string"){fs.open(b,"r",438,function(d,e){if(d){return a(d)}c.writeFile(e,a)});return}c.open(function(d,e){if(d){return a(d)}fs.fstat(b,function(f,j){if(f){return a(f)}var i=0;var g=0;var h=Math.min(j.size/e.chunkSize);var k=function(){fs.read(b,e.chunkSize,i,"binary",function(o,n,l){if(o){return a(o)}i=i+l;var m=new Chunk(e,{n:g++});m.write(n,function(q,p){if(q){return a(q)}p.save(function(r,s){if(r){return a(r)}e.position=e.position+n.length;e.currentChunk=p;if(i>=j.size){fs.close(b);e.close(a)}else{return process.nextTick(k)}})})})};process.nextTick(k)})})};var writeBuffer=function(o,a,e,b){if(typeof e==="function"){b=e;e=null}var f=(e==null)?false:e;if(o.mode[0]!="w"){b(new Error((o.referenceBy==REFERENCE_BY_ID?o.toHexString():o.filename)+" not opened for writing"),null)}else{if(o.currentChunk.position+a.length>=o.chunkSize){var n=o.currentChunk.chunkNumber;var k=o.chunkSize-o.currentChunk.position;var g=a.slice(0,k);var j=a.slice(k);var d=[o.currentChunk.write(g)];while(j.length>=o.chunkSize){var l=new Chunk(o,{n:(n+1)});var g=j.slice(0,o.chunkSize);j=j.slice(o.chunkSize);n=n+1;l.write(g);d.push(l)}o.currentChunk=new Chunk(o,{n:(n+1)});if(j.length>0){o.currentChunk.write(j)}o.position=o.position+a.length;var m=d.length;for(var h=0;h<d.length;h++){var c=d[h];c.save(function(i,p){if(i){return b(i)}m=m-1;if(m<=0){return b(null,o)}})}}else{o.position=o.position+a.length;o.currentChunk.write(a);b(null,o)}}};var buildMongoObject=function(g,a){var b=0;var f=g.previousChunkSize;if(null!=g.currentChunk&&g.currentChunk.chunkNumber>0&&g.currentChunk.position==0){b=g.currentChunk.chunkNumber-1}else{b=g.currentChunk.chunkNumber;f=g.currentChunk.position}var c=g.currentChunk!=null?(b*g.chunkSize+f):0;var e={_id:g.fileId,filename:g.filename,contentType:g.contentType,length:g.position?g.position:0,chunkSize:g.chunkSize,uploadDate:g.uploadDate,aliases:g.aliases,metadata:g.metadata};var d={filemd5:g.fileId,root:g.root};g.db.command(d,function(h,i){e.md5=i.md5;a(e)})};GridStore.prototype.close=function(a){var b=this;if(b.mode[0]=="w"){if(b.currentChunk!=null&&b.currentChunk.position>0){b.currentChunk.save(function(d,c){if(d){return a(d)}b.collection(function(e,f){if(e){return a(e)}if(b.uploadDate!=null){f.remove({_id:b.fileId},{safe:true},function(h,g){if(h){return a(h)}buildMongoObject(b,function(i){f.save(i,{safe:true},function(j){a(j,i)})})})}else{b.uploadDate=new Date();buildMongoObject(b,function(g){f.save(g,{safe:true},function(h){a(h,g)})})}})})}else{b.collection(function(c,d){if(c){return a(c)}b.uploadDate=new Date();buildMongoObject(b,function(e){d.save(e,{safe:true},function(f){a(f,e)})})})}}else{if(b.mode[0]=="r"){a(null,null)}else{a(new Error("Illegal mode "+b.mode),null)}}};var nthChunk=function(c,b,a){c.chunkCollection(function(e,d){if(e){return a(e)}d.find({files_id:c.fileId,n:b},function(g,f){if(g){return a(g)}f.nextObject(function(i,h){if(i){return a(i)}var j=h==null?{}:h;a(null,new Chunk(c,j))})})})};GridStore.prototype._nthChunk=function(b,a){nthChunk(this,b,a)};var lastChunkNumber=function(a){return Math.floor(a.length/a.chunkSize)};GridStore.prototype.chunkCollection=function(a){this.db.collection((this.root+".chunks"),a)};var deleteChunks=function(b,a){if(b.fileId!=null){b.chunkCollection(function(d,c){if(d){return a(d,false)}c.remove({files_id:b.fileId},{safe:true},function(e,f){if(e){return a(e,false)}a(null,true)})})}else{a(null,true)}};GridStore.prototype.unlink=function(a){var b=this;deleteChunks(this,function(c){if(c!==null){c.message="at deleteChunks: "+c.message;return a(c)}b.collection(function(e,d){if(e!==null){e.message="at collection: "+e.message;return a(e)}d.remove({_id:b.fileId},{safe:true},function(f){a(f,b)})})})};GridStore.prototype.collection=function(a){this.db.collection(this.root+".files",a)};GridStore.prototype.readlines=function(c,b){var a=Array.prototype.slice.call(arguments,0);b=a.pop();c=a.length?a.shift():"\n";this.read(function(e,d){if(e){return b(e)}var g=d.toString().split(c);g=g.length>0?g.splice(0,g.length-1):[];for(var f=0;f<g.length;f++){g[f]=g[f]+c}b(null,g)})};GridStore.prototype.rewind=function(a){var b=this;if(this.currentChunk.chunkNumber!=0){if(this.mode[0]=="w"){deleteChunks(b,function(c,d){if(c){return a(c)}b.currentChunk=new Chunk(b,{n:0});b.position=0;a(null,b)})}else{b.currentChunk(0,function(d,c){if(d){return a(d)}b.currentChunk=c;b.currentChunk.rewind();b.position=0;a(null,b)})}}else{b.currentChunk.rewind();b.position=0;a(null,b)}};GridStore.prototype.read=function(f,b,c){var g=this;var a=Array.prototype.slice.call(arguments,0);c=a.pop();f=a.length?a.shift():null;b=a.length?a.shift():null;var e=f==null?g.length-g.position:f;var d=b==null?new Buffer(e):b;d._index=b!=null&&b._index!=null?b._index:0;if((g.currentChunk.length()-g.currentChunk.position+d._index)>=e){var h=g.currentChunk.readSlice(e-d._index);h.copy(d,d._index);g.position=d.length;if(e==0&&d.length==0){return c(new Error("File does not exist"),null)}c(null,d)}else{var h=g.currentChunk.readSlice(g.currentChunk.length()-g.currentChunk.position);h.copy(d,d._index);d._index+=h.length;nthChunk(g,g.currentChunk.chunkNumber+1,function(j,i){if(j){return c(j)}if(i.length()>0){g.currentChunk=i;g.read(f,d,c)}else{if(d._index>0){c(null,d)}else{c(new Error("no chunks found for file, possibly corrupt"),null)}}})}};GridStore.prototype.tell=function(a){a(null,this.position)};GridStore.prototype.seek=function(e,g,b){var i=this;var a=Array.prototype.slice.call(arguments,1);b=a.pop();g=a.length?a.shift():null;var h=g==null?exports.GridStore.IO_SEEK_SET:g;var c=e;var j=0;if(h==exports.GridStore.IO_SEEK_CUR){j=i.position+c}else{if(h==exports.GridStore.IO_SEEK_END){j=i.length+c}else{j=c}}var d=Math.floor(j/i.chunkSize);if(d!=i.currentChunk.chunkNumber){var f=function(){nthChunk(i,d,function(l,k){i.currentChunk=k;i.position=j;i.currentChunk.position=(i.position%i.chunkSize);b(l,i)})};if(i.mode[0]=="w"){i.currentChunk.save(function(k){if(k){return b(k)}f()})}else{f()}}else{i.position=j;i.currentChunk.position=(i.position%i.chunkSize);b(null,i)}};GridStore.prototype.eof=function(){return this.position==this.length?true:false};GridStore.prototype.getc=function(a){var b=this;if(b.eof()){a(null,null)}else{if(b.currentChunk.eof()){nthChunk(b,b.currentChunk.chunkNumber+1,function(d,c){b.currentChunk=c;b.position=b.position+1;a(d,b.currentChunk.getc())})}else{b.position=b.position+1;a(null,b.currentChunk.getc())}}};GridStore.prototype.puts=function(c,a){var b=c.match(/\n$/)==null?c+"\n":c;this.write(b,a)};GridStore.prototype.stream=function(a){return new ReadStream(a,this)};GridStore.DEFAULT_ROOT_COLLECTION="fs";GridStore.DEFAULT_CONTENT_TYPE="binary/octet-stream";GridStore.IO_SEEK_SET=0;GridStore.IO_SEEK_CUR=1;GridStore.IO_SEEK_END=2;GridStore.exist=function(c,d,e,b){var a=Array.prototype.slice.call(arguments,2);b=a.pop();e=a.length?a.shift():null;var f=e!=null?e:GridStore.DEFAULT_ROOT_COLLECTION;c.collection(f+".files",function(h,g){if(h){return b(h)}var i=(typeof d=="string"||Object.prototype.toString.call(d)=="[object RegExp]")?{filename:d}:{_id:d};g.find(i,function(k,j){if(k){return b(k)}j.nextObject(function(l,m){if(l){return b(l)}b(null,m==null?false:true)})})})};GridStore.list=function(d,g,f,c){var a=Array.prototype.slice.call(arguments,1);c=a.pop();g=a.length?a.shift():null;f=a.length?a.shift():{};if(g!=null&&typeof g=="object"){f=g;g=null}var b=f.id!=null?f.id:false;var h=g!=null?g:GridStore.DEFAULT_ROOT_COLLECTION;var e=[];d.collection((h+".files"),function(j,i){if(j){return c(j)}i.find(function(l,k){if(l){return c(l)}k.each(function(m,n){if(n!=null){e.push(b?n._id:n.filename)}else{c(m,e)}})})})};GridStore.read=function(c,e,d,f,g,b){var a=Array.prototype.slice.call(arguments,2);b=a.pop();d=a.length?a.shift():null;f=a.length?a.shift():null;g=a.length?a.shift():null;new GridStore(c,e,"r",g).open(function(h,i){if(h){return b(h)}if(f&&f>=i.length){return b("offset larger than size of file",null)}if(d&&d>i.length){return b("length is larger than the size of the file",null)}if(f&&d&&(f+d)>i.length){return b("offset and length is larger than the size of the file",null)}if(f!=null){i.seek(f,function(j,k){if(j){return b(j)}k.read(d,b)})}else{i.read(d,b)}})};GridStore.readlines=function(c,e,g,f,b){var a=Array.prototype.slice.call(arguments,2);b=a.pop();g=a.length?a.shift():null;f=a.length?a.shift():null;var d=g==null?"\n":g;new GridStore(c,e,"r",f).open(function(h,i){if(h){return b(h)}i.readlines(d,b)})};GridStore.unlink=function(c,e,f,b){var g=this;var a=Array.prototype.slice.call(arguments,2);b=a.pop();f=a.length?a.shift():null;if(e.constructor==Array){var h=0;for(var d=0;d<e.length;d++){++h;g.unlink(c,e[d],function(i){if(--h==0){b(null,g)}})}}else{new GridStore(c,e,"w",f).open(function(i,j){if(i){return b(i)}deleteChunks(j,function(k,l){if(k){return b(k)}j.collection(function(n,m){if(n){return b(n)}m.remove({_id:j.fileId},{safe:true},function(p,o){b(p,g)})})})})}};Object.defineProperty(GridStore.prototype,"chunkSize",{enumerable:true,get:function(){return this.internalChunkSize},set:function(a){if(!(this.mode[0]=="w"&&this.position==0&&this.uploadDate==null)){this.internalChunkSize=this.internalChunkSize}else{this.internalChunkSize=a}}});Object.defineProperty(GridStore.prototype,"md5",{enumerable:true,get:function(){return this.internalMd5}});Object.defineProperty(GridStore.prototype,"writable",{enumerable:true,get:function(){if(this._writeable==null){this._writeable=this.mode!=null&&this.mode.indexOf("w")!=-1}return this._writeable},set:function(a){this._writeable=a}});Object.defineProperty(GridStore.prototype,"readable",{enumerable:true,get:function(){if(this._readable==null){this._readable=this.mode!=null&&this.mode.indexOf("r")!=-1}return this._readable},set:function(a){this._readable=a}});GridStore.prototype.paused;GridStore.prototype.setEncoding=fs.ReadStream.prototype.setEncoding;GridStore.prototype.end=function end(a){var b=this;if(!this.writable){return}this.writable=false;if(a){this._q.push(a)}this.on("drain",function(){b.close(function(c){if(c){return _error(b,c)}b.emit("close")})});_flush(b)};var _writeNormal=function(d,c,b,a){if(Buffer.isBuffer(c)){return writeBuffer(d,c,b,a)}else{return writeBuffer(d,new Buffer(c,"binary"),b,a)}};GridStore.prototype.write=function write(c,b,a){if(typeof b=="function"||typeof a=="function"){return _writeNormal(this,c,b,a)}var d=this;if(!this.writable){throw new Error("GridWriteStream is not writable")}if(!this._opened){this._q=[];_openStream(d);this._q.push(c);return false}this._q.push(c);_flush(this);return true};GridStore.prototype.destroy=function destroy(){if(!this.writable){return}this.readable=false;if(this.writable){this.writable=false;this._q.length=0;this.emit("close")}};GridStore.prototype.destroySoon=function destroySoon(){if(!this._q.length){return this.destroy()}this._destroying=true};GridStore.prototype.pipe=function(a,b){var c=this;this.open(function(d,e){if(d){_errorRead(c,d)}if(!c.readable){return}c._pipe(a,b);c.emit("open");_read(c)})};var _read=function _read(a){if(!a.readable||a.paused||a.reading){return}a.reading=true;var b=a._stream=a.stream();b.paused=a.paused;b.on("data",function(c){if(a._decoder){var d=a._decoder.write(c);if(d.length){a.emit("data",d)}}else{a.emit("data",c)}});b.on("end",function(c){a.emit("end",c)});b.on("error",function(c){_errorRead(a,c)});b.on("close",function(c){a.emit("close",c)});a.pause=function(){a.paused=b.paused=true};a.resume=function(){a.paused=false;b.resume();a.readable=b.readable};a.destroy=function(){a.readable=false;b.destroy()}};GridStore.prototype.pause=function pause(){this.paused=true};GridStore.prototype.resume=function resume(){this.paused=false};var _flush=function _flush(b,a){if(!b._opened){return}if(!a&&b._flushing){return}b._flushing=true;if(!b._q.length){b._flushing=false;b.emit("drain");if(b._destroying){b.destroy()}return}b.write(b._q.shift(),function(c,d){if(c){return _error(b,c)}b.emit("progress",d.position);_flush(b,true)})};var _openStream=function _openStream(a){if(a._opening==true){return}a._opening=true;a.open(function(b,c){if(b){return _error(a,b)}a._opened=true;a.emit("open");_flush(a)})};var _error=function _error(b,a){b.destroy();b.emit("error",a)};var _errorRead=function _errorRead(b,a){b.readable=false;b.emit("error",a)};exports.GridStore=GridStore;