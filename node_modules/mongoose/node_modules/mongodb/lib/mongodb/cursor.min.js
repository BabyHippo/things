var QueryCommand=require("./commands/query_command").QueryCommand,GetMoreCommand=require("./commands/get_more_command").GetMoreCommand,KillCursorCommand=require("./commands/kill_cursor_command").KillCursorCommand,Long=require("bson").Long,CursorStream=require("./cursorstream"),utils=require("./utils");function Cursor(e,c,r,h,t,j,w,i,g,v,y,x,b,u,o,p,q,l,m,k,s,d,a,n,f){this.db=e;this.collection=c;this.selector=r;this.fields=h;this.skipValue=t==null?0:t;this.limitValue=j==null?0:j;this.sortValue=w;this.hint=i;this.explainValue=g;this.snapshot=v;this.timeout=y==null?true:y;this.tailable=x;this.awaitdata=a;this.numberOfRetries=n==null?1:n;this.batchSizeValue=b==null?0:b;this.slaveOk=u==null?c.slaveOk:u;this.raw=o==null?false:o;this.read=p==null?true:p;this.returnKey=q;this.maxScan=l;this.min=m;this.max=k;this.showDiskLoc=s;this.comment=d;this.totalNumberOfRecords=0;this.items=[];this.cursorId=Long.fromInt(0);this.dbName=f;this.state=Cursor.INIT;this.queryRun=false;this.getMoreTimer=false;if(this.dbName!=null){this.collectionName=this.dbName+"."+this.collection.collectionName}else{this.collectionName=(this.db.databaseName?this.db.databaseName+".":"")+this.collection.collectionName}}Cursor.prototype.rewind=function(){var a=this;if(a.state!=Cursor.INIT){if(a.state!=Cursor.CLOSED){a.close(function(){})}a.numberOfReturned=0;a.totalNumberOfRecords=0;a.items=[];a.cursorId=Long.fromInt(0);a.state=Cursor.INIT;a.queryRun=false}return a};Cursor.prototype.toArray=function(a){var c=this;if(!a){throw new Error("callback is mandatory")}if(this.tailable){a(new Error("Tailable cursor cannot be converted to array"),null)}else{if(this.state!=Cursor.CLOSED){var b=[];this.each(function(d,e){if(d!=null){return a(d,null)}if(e!=null){b.push(e)}else{var f=b;b=null;c.items=[];a(d,f)}})}else{a(new Error("Cursor is closed"),null)}}};Cursor.prototype.each=function(a){var b=this;if(!a){throw new Error("callback is mandatory")}if(this.state!=Cursor.CLOSED){process.nextTick(function(){var c=new Date();b.nextObject(function(d,e){if(d!=null){return a(d,null)}if(e!=null){a(null,e);b.each(a)}else{b.state=Cursor.CLOSED;a(d,null)}})})}else{a(new Error("Cursor is closed"),null)}};Cursor.prototype.count=function(a){this.collection.count(this.selector,a)};Cursor.prototype.sort=function(c,b,a){a=a||function(){};if(typeof b==="function"){a=b;b=null}if(this.tailable){a(new Error("Tailable cursor doesn't support sorting"),null)}else{if(this.queryRun==true||this.state==Cursor.CLOSED){a(new Error("Cursor is closed"),null)}else{var d=c;if(b!=null){d=[[c,b]]}this.sortValue=d;a(null,this)}}return this};Cursor.prototype.limit=function(b,a){if(this.tailable){if(a){a(new Error("Tailable cursor doesn't support limit"),null)}else{throw new Error("Tailable cursor doesn't support limit")}}else{if(this.queryRun==true||this.state==Cursor.CLOSED){if(a){a(new Error("Cursor is closed"),null)}else{throw new Error("Cursor is closed")}}else{if(b!=null&&b.constructor!=Number){if(a){a(new Error("limit requires an integer"),null)}else{throw new Error("limit requires an integer")}}else{this.limitValue=b;if(a){return a(null,this)}}}}return this};Cursor.prototype.setReadPreference=function(b,c,a){if(typeof c=="function"){a=c}a=a||function(){};if(this.queryRun==true||this.state==Cursor.CLOSED){a(new Error("Cannot change read preference on executed query or closed cursor"))}else{if(b==null&&b!="primary"&&b!="secondaryOnly"&&b!="secondary"){a(new Error("only readPreference of primary, secondary or secondaryOnly supported"))}else{this.read=b}}return this};Cursor.prototype.skip=function(b,a){a=a||function(){};if(this.tailable){a(new Error("Tailable cursor doesn't support skip"),null)}else{if(this.queryRun==true||this.state==Cursor.CLOSED){a(new Error("Cursor is closed"),null)}else{if(b!=null&&b.constructor!=Number){a(new Error("skip requires an integer"),null)}else{this.skipValue=b;a(null,this)}}}return this};Cursor.prototype.batchSize=function(a,b){if(this.state==Cursor.CLOSED){if(b!=null){return b(new Error("Cursor is closed"),null)}else{throw new Error("Cursor is closed")}}else{if(a!=null&&a.constructor!=Number){if(b!=null){return b(new Error("batchSize requires an integer"),null)}else{throw new Error("batchSize requires an integer")}}else{this.batchSizeValue=a;if(b!=null){return b(null,this)}}}return this};var limitRequest=function(d){var c=d.limitValue;var b=Math.abs(d.limitValue);var a=Math.abs(d.batchSizeValue);if(b>0){if(a>0){c=Math.min(b,a)}}else{c=d.batchSizeValue}return c};var generateQueryCommand=function(c){var b=QueryCommand.OPTS_NONE;if(!c.timeout){b|=QueryCommand.OPTS_NO_CURSOR_TIMEOUT}if(c.tailable!=null){b|=QueryCommand.OPTS_TAILABLE_CURSOR;c.skipValue=c.limitValue=0;if(c.awaitdata!=null){b|=QueryCommand.OPTS_AWAIT_DATA}}if(c.slaveOk){b|=QueryCommand.OPTS_SLAVE}var a=c.limitValue==-1?-1:limitRequest(c);if(c.sortValue!=null||c.explainValue!=null||c.hint!=null||c.snapshot!=null||c.returnKey!=null||c.maxScan!=null||c.min!=null||c.max!=null||c.showDiskLoc!=null||c.comment!=null){var d={"$query":c.selector};if(c.sortValue!=null){d.orderby=utils.formattedOrderClause(c.sortValue)}if(c.hint!=null&&c.hint.constructor==Object){d["$hint"]=c.hint}if(c.snapshot!=null){d["$snapshot"]=true}if(c.returnKey!=null){d["$returnKey"]=c.returnKey}if(c.maxScan!=null){d["$maxScan"]=c.maxScan}if(c.min!=null){d["$min"]=c.min}if(c.max!=null){d["$max"]=c.max}if(c.showDiskLoc!=null){d["$showDiskLoc"]=c.showDiskLoc}if(c.comment!=null){d["$comment"]=c.comment}if(c.explainValue!=null){a=(-1)*Math.abs(a);d["$explain"]=true}return new QueryCommand(c.db,c.collectionName,b,c.skipValue,a,d,c.fields)}else{return new QueryCommand(c.db,c.collectionName,b,c.skipValue,a,c.selector,c.fields)}};Cursor.prototype.formattedOrderClause=function(){return utils.formattedOrderClause(this.sortValue)};Cursor.prototype.formatSortValue=function(a){return utils.formatSortValue(a)};Cursor.prototype.nextObject=function(a){var e=this;if(e.state==Cursor.INIT){var b;try{b=generateQueryCommand(e)}catch(d){return a(d,null)}var c=function(f,h){if(f!=null&&h==null){return a(f,null)}if(!f&&h.documents[0]&&h.documents[0]["$err"]){return e.close(function(){a(h.documents[0]["$err"],null)})}e.queryRun=true;e.state=Cursor.OPEN;e.cursorId=h.cursorId;e.totalNumberOfRecords=h.numberReturned;for(var g=0;g<h.documents.length;g++){e.items.push(h.documents[g])}h=null;e.nextObject(a)};if(e.connection==null){try{e.connection=this.read==null?e.db.serverConfig.checkoutWriter():e.db.serverConfig.checkoutReader(this.read)}catch(d){return a(d,null)}}e.db._executeQueryCommand(b,{raw:e.raw,read:this.read,connection:e.connection},c);c=null}else{if(e.items.length){a(null,e.items.shift())}else{if(e.cursorId.greaterThan(Long.fromInt(0))){getMore(e,a)}else{return e.close(function(){a(null,null)})}}}};var getMore=function(g,a){var e=0;if(!g.tailable&&g.limitValue>0){e=g.limitValue-g.totalNumberOfRecords;if(e<1){g.close(function(){a(null,null)});return}}try{var c=new GetMoreCommand(g.db,g.collectionName,limitRequest(g),g.cursorId);var f={read:g.read,raw:g.raw,connection:g.connection};g.db._executeQueryCommand(c,f,function(h,k){try{if(h!=null){return a(h,null)}var j=1===k.responseFlag&&k.cursorId.isZero();g.cursorId=k.cursorId;g.totalNumberOfRecords+=k.numberReturned;if(k.numberReturned>0){if(g.limitValue>0){var i=g.totalNumberOfRecords-g.limitValue;if(i>0){k.documents.splice(-1*i,i)}}g.items=g.items.concat(k.documents);a(null,g.items.shift())}else{if(g.tailable&&!j&&g.awaitdata){g.numberOfRetries=g.numberOfRetries-1;if(g.numberOfRetries==0){g.close(function(){a(new Error("tailable cursor timed out"),null)})}else{process.nextTick(function(){getMore(g,a)})}}else{if(g.tailable&&!j){g.getMoreTimer=setTimeout(function(){getMore(g,a)},100)}else{g.close(function(){a(null,null)})}}}k=null}catch(h){a(h,null)}});c=null}catch(b){var d=function(){a(b,null)};g.close(d);d=null}};Cursor.prototype.explain=function(a){var c=(-1)*Math.abs(this.limitValue);var b=new Cursor(this.db,this.collection,this.selector,this.fields,this.skipValue,c,this.sortValue,this.hint,true,this.snapshot,this.timeout,this.tailable,this.batchSizeValue,this.slaveOk,this.raw,this.read,this.returnKey,this.maxScan,this.min,this.max,this.showDiskLoc,this.comment,this.awaitdata,this.numberOfRetries,this.dbName);b.nextObject(function(d,e){if(d!=null){return a(d,null)}b.close(function(f,g){if(f!=null){return a(f,null)}a(null,e)})})};Cursor.prototype.streamRecords=function(d){var a=Array.prototype.slice.call(arguments,0);d=a.length?a.shift():{};var g=this,h=new process.EventEmitter(),f=this.limitValue||0,b=0,e=generateQueryCommand(g);e.numberToReturn=d.fetchSize?d.fetchSize:500;c(e);function c(i){g.db._executeQueryCommand(i,{read:g.read,raw:g.raw,connection:g.connection},function(j,l){if(j){h.emit("error",j);g.close(function(){});return}if(!g.queryRun&&l){g.queryRun=true;g.cursorId=l.cursorId;g.state=Cursor.OPEN;g.getMoreCommand=new GetMoreCommand(g.db,g.collectionName,e.numberToReturn,l.cursorId)}var k={CursorNotFound:1<<0,QueryFailure:1<<1,ShardConfigStale:1<<2,AwaitCapable:1<<3};if(l.documents&&l.documents.length&&!(l.responseFlag&k.QueryFailure)){try{l.documents.forEach(function(m){if(f&&b>=f){throw ("done")}b++;h.emit("data",m)})}catch(j){if(j!="done"){throw j}else{g.close(function(){h.emit("end",f)});g.close(function(){});return}}c(g.getMoreCommand)}else{g.close(function(){h.emit("end",f)})}})}return h};Cursor.prototype.stream=function stream(){return new CursorStream(this)};Cursor.prototype.close=function(a){var d=this;this.getMoreTimer&&clearTimeout(this.getMoreTimer);if(this.cursorId instanceof Long&&this.cursorId.greaterThan(Long.fromInt(0))){try{var b=new KillCursorCommand(this.db,[this.cursorId]);this.db._executeQueryCommand(b,{read:d.read,raw:d.raw,connection:d.connection},null)}catch(c){}}d.connection=null;this.cursorId=Long.fromInt(0);this.state=Cursor.CLOSED;if(a){a(null,d);d.items=[]}return this};Cursor.prototype.isClosed=function(){return this.state==Cursor.CLOSED?true:false};Cursor.INIT=0;Cursor.OPEN=1;Cursor.CLOSED=2;exports.Cursor=Cursor;