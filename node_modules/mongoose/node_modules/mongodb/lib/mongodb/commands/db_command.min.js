var QueryCommand=require("./query_command").QueryCommand,InsertCommand=require("./insert_command").InsertCommand,inherits=require("util").inherits,crypto=require("crypto");var DbCommand=exports.DbCommand=function(b,a,g,d,c,f,h,e){QueryCommand.call(this);this.collectionName=a;this.queryOptions=g;this.numberToSkip=d;this.numberToReturn=c;this.query=f;this.returnFieldSelector=h;this.db=b;e=e==null?{}:e;if(e.serializeFunctions!=null&&e.serializeFunctions){this.serializeFunctions=true}};inherits(DbCommand,QueryCommand);DbCommand.SYSTEM_NAMESPACE_COLLECTION="system.namespaces";DbCommand.SYSTEM_INDEX_COLLECTION="system.indexes";DbCommand.SYSTEM_PROFILE_COLLECTION="system.profile";DbCommand.SYSTEM_USER_COLLECTION="system.users";DbCommand.SYSTEM_COMMAND_COLLECTION="$cmd";DbCommand.NcreateIsMasterCommand=function(b,a){return new DbCommand(b,a+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{ismaster:1},null)};DbCommand.createIsMasterCommand=function(a){return new DbCommand(a,a.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{ismaster:1},null)};DbCommand.createCollectionInfoCommand=function(a,b){return new DbCommand(a,a.databaseName+"."+DbCommand.SYSTEM_NAMESPACE_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,0,b,null)};DbCommand.createGetNonceCommand=function(a,b){return new DbCommand(a,a.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{getnonce:1},null)};DbCommand.createAuthenticationCommand=function(b,i,g,f,a){var e=crypto.createHash("md5");e.update(i+":mongo:"+g);var c=e.digest("hex");e=crypto.createHash("md5");e.update(f+i+c);var d=e.digest("hex");var h={authenticate:1,user:i,nonce:f,key:d};return new DbCommand(b,a+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NONE,0,-1,h,null)};DbCommand.createLogoutCommand=function(a){return new DbCommand(a,a.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{logout:1},null)};DbCommand.createCreateCollectionCommand=function(b,a,d){var e={create:a};for(var c in d){if(d[c]!=null&&d[c].constructor!=Function){e[c]=d[c]}}return new DbCommand(b,b.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,e,null)};DbCommand.createDropCollectionCommand=function(b,a){return new DbCommand(b,b.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{drop:a},null)};DbCommand.createRenameCollectionCommand=function(a,b,e){var c=a.databaseName+"."+b;var d=a.databaseName+"."+e;return new DbCommand(a,"admin."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{renameCollection:c,to:d},null)};DbCommand.createGetLastErrorCommand=function(d,b){if(typeof b==="undefined"){b=d;d={}}var a={getlasterror:1};if("object"===typeof d){for(var c in d){a[c]=d[c]}}return new DbCommand(b,b.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,a,null)};DbCommand.createGetLastStatusCommand=DbCommand.createGetLastErrorCommand;DbCommand.createGetPreviousErrorsCommand=function(a){return new DbCommand(a,a.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{getpreverror:1},null)};DbCommand.createResetErrorHistoryCommand=function(a){return new DbCommand(a,a.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{reseterror:1},null)};DbCommand.createCreateIndexCommand=function(b,a,d,k){var c={};var g=[];var j;if(d.constructor===String){g.push(d+"_"+1);c[d]=1}else{if(d.constructor===Array){d.forEach(function(i){if(i.constructor===String){g.push(i+"_"+1);c[i]=1}else{if(i.constructor===Array){g.push(i[0]+"_"+(i[1]||1));c[i[0]]=i[1]||1}else{if(i.constructor===Object){j=Object.keys(i);j.forEach(function(m){g.push(m+"_"+i[m]);c[m]=i[m]})}else{}}}})}else{if(d.constructor===Object){j=Object.keys(d);j.forEach(function(i){g.push(i+"_"+d[i]);c[i]=d[i]})}}}var h=g.join("_");var l={ns:(b.databaseName+"."+a),key:c,name:h};var e=k==null||"object"===typeof k?false:k;k=k==null||typeof k=="boolean"?{}:k;var j=Object.keys(k);for(var f=0;f<j.length;f++){l[j[f]]=k[j[f]]}if(l.unique==null){l.unique=e}return new InsertCommand(b,b.databaseName+"."+DbCommand.SYSTEM_INDEX_COLLECTION,false).add(l)};DbCommand.logoutCommand=function(b,a,d){var c=d!=null&&d.authdb!=null?d.authdb:b.databaseName;return new DbCommand(b,c+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,a,null)};DbCommand.createDropIndexCommand=function(b,a,c){return new DbCommand(b,b.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{deleteIndexes:a,index:c},null)};DbCommand.createReIndexCommand=function(b,a){return new DbCommand(b,b.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{reIndex:a},null)};DbCommand.createDropDatabaseCommand=function(a){return new DbCommand(a,a.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{dropDatabase:1},null)};DbCommand.createDbCommand=function(b,a,c){return new DbCommand(b,b.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,a,null,c)};DbCommand.createAdminDbCommand=function(b,a){return new DbCommand(b,"admin."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,a,null)};DbCommand.createAdminDbCommandSlaveOk=function(b,a){return new DbCommand(b,"admin."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT|QueryCommand.OPTS_SLAVE,0,-1,a,null)};DbCommand.createDbSlaveOkCommand=function(b,a,c){return new DbCommand(b,b.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT|QueryCommand.OPTS_SLAVE,0,-1,a,null,c)};