var BaseCommand=require("./base_command").BaseCommand,inherits=require("util").inherits;var QueryCommand=exports.QueryCommand=function(b,a,j,e,d,i,k,h){BaseCommand.call(this);var f=i,g;if(Buffer.isBuffer(f)){g=f[0]|f[1]<<8|f[2]<<16|f[3]<<24;if(g!=f.length){var c=new Error("query selector raw message size does not match message header size ["+f.length+"] != ["+g+"]");c.name="MongoError";throw c}}f=k;if(Buffer.isBuffer(f)){g=f[0]|f[1]<<8|f[2]<<16|f[3]<<24;if(g!=f.length){var c=new Error("query fields raw message size does not match message header size ["+f.length+"] != ["+g+"]");c.name="MongoError";throw c}}h=h==null?{}:h;this.collectionName=a;this.queryOptions=j;this.numberToSkip=e;this.numberToReturn=d;i=i==null?{}:i;this.query=i;this.returnFieldSelector=k;this.db=b;if(h.serializeFunctions!=null&&h.serializeFunctions){this.serializeFunctions=true}};inherits(QueryCommand,BaseCommand);QueryCommand.OP_QUERY=2004;QueryCommand.prototype.setMongosReadPreference=function(a,b){this.queryOptions|=QueryCommand.OPTS_SLAVE;if((a!=null||b!=null)&&this.query["$query"]==null){this.query={"$query":this.query}}if(a==null&&b==null){if(this.queryOptions&QueryCommand.OPTS_SLAVE){this.query["$readPreference"]={mode:"secondary"}}else{this.query["$readPreference"]={mode:"primary"}}}if(typeof a=="object"&&a._type=="ReadPreference"){this.query["$readPreference"]=a.toObject()}else{if(a!=null){this.query["$readPreference"]={mode:a};if(b!=null){this.query["$readPreference"]["tags"]=b}}}};QueryCommand.prototype.toBinary=function(){var e=0;if(Buffer.isBuffer(this.query)){e=4+Buffer.byteLength(this.collectionName)+1+4+4+this.query.length+(4*4)}else{e=4+Buffer.byteLength(this.collectionName)+1+4+4+this.db.bson.calculateObjectSize(this.query,this.serializeFunctions,true)+(4*4)}if(this.returnFieldSelector!=null&&!(Buffer.isBuffer(this.returnFieldSelector))){if(Object.keys(this.returnFieldSelector).length>0){e+=this.db.bson.calculateObjectSize(this.returnFieldSelector,this.serializeFunctions,true)}}else{if(Buffer.isBuffer(this.returnFieldSelector)){e+=this.returnFieldSelector.length}}var b=0;var a=new Buffer(e);a[b+3]=(e>>24)&255;a[b+2]=(e>>16)&255;a[b+1]=(e>>8)&255;a[b]=e&255;b=b+4;a[b+3]=(this.requestId>>24)&255;a[b+2]=(this.requestId>>16)&255;a[b+1]=(this.requestId>>8)&255;a[b]=this.requestId&255;b=b+4;a[b++]=0;a[b++]=0;a[b++]=0;a[b++]=0;a[b+3]=(QueryCommand.OP_QUERY>>24)&255;a[b+2]=(QueryCommand.OP_QUERY>>16)&255;a[b+1]=(QueryCommand.OP_QUERY>>8)&255;a[b]=QueryCommand.OP_QUERY&255;b=b+4;a[b+3]=(this.queryOptions>>24)&255;a[b+2]=(this.queryOptions>>16)&255;a[b+1]=(this.queryOptions>>8)&255;a[b]=this.queryOptions&255;b=b+4;b=b+a.write(this.collectionName,b,"utf8")+1;a[b-1]=0;a[b+3]=(this.numberToSkip>>24)&255;a[b+2]=(this.numberToSkip>>16)&255;a[b+1]=(this.numberToSkip>>8)&255;a[b]=this.numberToSkip&255;b=b+4;a[b+3]=(this.numberToReturn>>24)&255;a[b+2]=(this.numberToReturn>>16)&255;a[b+1]=(this.numberToReturn>>8)&255;a[b]=this.numberToReturn&255;b=b+4;var c=0;var d=this.query;if(Buffer.isBuffer(d)){c=d.length;d.copy(a,b)}else{c=this.db.bson.serializeWithBufferAndIndex(d,this.checkKeys,a,b,this.serializeFunctions)-b+1}a[b+3]=(c>>24)&255;a[b+2]=(c>>16)&255;a[b+1]=(c>>8)&255;a[b]=c&255;b=b+c;a[b-1]=0;if(this.returnFieldSelector!=null&&!(Buffer.isBuffer(this.returnFieldSelector))){if(Object.keys(this.returnFieldSelector).length>0){var c=this.db.bson.serializeWithBufferAndIndex(this.returnFieldSelector,this.checkKeys,a,b,this.serializeFunctions)-b+1;a[b+3]=(c>>24)&255;a[b+2]=(c>>16)&255;a[b+1]=(c>>8)&255;a[b]=c&255;b=b+c;a[b-1]=0}}if(this.returnFieldSelector!=null&&Buffer.isBuffer(this.returnFieldSelector)){var c=0;var d=this.returnFieldSelector;c=d.length;d.copy(a,b);a[b+3]=(c>>24)&255;a[b+2]=(c>>16)&255;a[b+1]=(c>>8)&255;a[b]=c&255;b=b+c;a[b-1]=0}return a};QueryCommand.OPTS_NONE=0;QueryCommand.OPTS_TAILABLE_CURSOR=2;QueryCommand.OPTS_SLAVE=4;QueryCommand.OPTS_OPLOG_REPLY=8;QueryCommand.OPTS_NO_CURSOR_TIMEOUT=16;QueryCommand.OPTS_AWAIT_DATA=32;QueryCommand.OPTS_EXHAUST=64;