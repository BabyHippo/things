var BaseCommand=require("./base_command").BaseCommand,inherits=require("util").inherits;var InsertCommand=exports.InsertCommand=function(c,b,a,d){BaseCommand.call(this);this.collectionName=b;this.documents=[];this.checkKeys=a==null?true:a;this.db=c;this.flags=0;this.serializeFunctions=false;d=d==null?{}:d;if(d.keepGoing!=null&&d.keepGoing){this.flags=1}if(d.serializeFunctions!=null&&d.serializeFunctions){this.serializeFunctions=true}};inherits(InsertCommand,BaseCommand);InsertCommand.OP_INSERT=2002;InsertCommand.prototype.add=function(a){if(Buffer.isBuffer(a)){var c=a[0]|a[1]<<8|a[2]<<16|a[3]<<24;if(c!=a.length){var b=new Error("insert raw message size does not match message header size ["+a.length+"] != ["+c+"]");b.name="MongoError";throw b}}this.documents.push(a);return this};InsertCommand.prototype.toBinary=function(){var f=4+Buffer.byteLength(this.collectionName)+1+(4*4);for(var d=0;d<this.documents.length;d++){if(Buffer.isBuffer(this.documents[d])){f+=this.documents[d].length}else{f+=this.db.bson.calculateObjectSize(this.documents[d],this.serializeFunctions,true)}}var b=0;var a=new Buffer(f);a[b+3]=(f>>24)&255;a[b+2]=(f>>16)&255;a[b+1]=(f>>8)&255;a[b]=f&255;b=b+4;a[b+3]=(this.requestId>>24)&255;a[b+2]=(this.requestId>>16)&255;a[b+1]=(this.requestId>>8)&255;a[b]=this.requestId&255;b=b+4;a[b++]=0;a[b++]=0;a[b++]=0;a[b++]=0;a[b+3]=(InsertCommand.OP_INSERT>>24)&255;a[b+2]=(InsertCommand.OP_INSERT>>16)&255;a[b+1]=(InsertCommand.OP_INSERT>>8)&255;a[b]=InsertCommand.OP_INSERT&255;b=b+4;a[b+3]=(this.flags>>24)&255;a[b+2]=(this.flags>>16)&255;a[b+1]=(this.flags>>8)&255;a[b]=this.flags&255;b=b+4;b=b+a.write(this.collectionName,b,"utf8")+1;a[b-1]=0;for(var d=0;d<this.documents.length;d++){var c=0;var e=this.documents[d];if(Buffer.isBuffer(e)){c=e.length;e.copy(a,b)}else{c=this.db.bson.serializeWithBufferAndIndex(e,this.checkKeys,a,b,this.serializeFunctions)-b+1}a[b+3]=(c>>24)&255;a[b+2]=(c>>16)&255;a[b+1]=(c>>8)&255;a[b]=c&255;b=b+c;a[b-1]=0}return a};