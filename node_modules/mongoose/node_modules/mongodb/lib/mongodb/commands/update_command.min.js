var BaseCommand=require("./base_command").BaseCommand,inherits=require("util").inherits;var UpdateCommand=exports.UpdateCommand=function(b,a,j,e,i){BaseCommand.call(this);var g=j;if(Buffer.isBuffer(g)){var h=g[0]|g[1]<<8|g[2]<<16|g[3]<<24;if(h!=g.length){var f=new Error("update spec raw message size does not match message header size ["+g.length+"] != ["+h+"]");f.name="MongoError";throw f}}var g=e;if(Buffer.isBuffer(g)){var h=g[0]|g[1]<<8|g[2]<<16|g[3]<<24;if(h!=g.length){var f=new Error("update document raw message size does not match message header size ["+g.length+"] != ["+h+"]");f.name="MongoError";throw f}}this.collectionName=a;this.spec=j;this.document=e;this.db=b;this.serializeFunctions=false;var d=0;var c=0;d=i!=null&&i.upsert!=null?(i.upsert==true?1:0):d;c=i!=null&&i.multi!=null?(i.multi==true?1:0):c;this.flags=parseInt(c.toString()+d.toString(),2);if(i.serializeFunctions!=null&&i.serializeFunctions){this.serializeFunctions=true}};inherits(UpdateCommand,BaseCommand);UpdateCommand.OP_UPDATE=2001;UpdateCommand.prototype.toBinary=function(){var f=4+Buffer.byteLength(this.collectionName)+1+4+this.db.bson.calculateObjectSize(this.spec,false,true)+this.db.bson.calculateObjectSize(this.document,this.serializeFunctions,true)+(4*4);var b=0;var a=new Buffer(f);a[b+3]=(f>>24)&255;a[b+2]=(f>>16)&255;a[b+1]=(f>>8)&255;a[b]=f&255;b=b+4;a[b+3]=(this.requestId>>24)&255;a[b+2]=(this.requestId>>16)&255;a[b+1]=(this.requestId>>8)&255;a[b]=this.requestId&255;b=b+4;a[b++]=0;a[b++]=0;a[b++]=0;a[b++]=0;a[b+3]=(UpdateCommand.OP_UPDATE>>24)&255;a[b+2]=(UpdateCommand.OP_UPDATE>>16)&255;a[b+1]=(UpdateCommand.OP_UPDATE>>8)&255;a[b]=UpdateCommand.OP_UPDATE&255;b=b+4;a[b++]=0;a[b++]=0;a[b++]=0;a[b++]=0;b=b+a.write(this.collectionName,b,"utf8")+1;a[b-1]=0;a[b+3]=(this.flags>>24)&255;a[b+2]=(this.flags>>16)&255;a[b+1]=(this.flags>>8)&255;a[b]=this.flags&255;b=b+4;var c=0;var d=this.spec;if(Buffer.isBuffer(d)){var e=d[0]|d[1]<<8|d[2]<<16|d[3]<<24;if(e!=d.length){throw new Error("raw message size does not match message header size ["+d.length+"] != ["+e+"]")}c=d.length;d.copy(a,b)}else{c=this.db.bson.serializeWithBufferAndIndex(d,this.checkKeys,a,b,false)-b+1}a[b+3]=(c>>24)&255;a[b+2]=(c>>16)&255;a[b+1]=(c>>8)&255;a[b]=c&255;b=b+c;a[b-1]=0;var c=0;var d=this.document;if(Buffer.isBuffer(d)){var e=d[0]|d[1]<<8|d[2]<<16|d[3]<<24;if(e!=d.length){throw new Error("raw message size does not match message header size ["+d.length+"] != ["+e+"]")}c=d.length;d.copy(a,b)}else{c=this.db.bson.serializeWithBufferAndIndex(d,this.checkKeys,a,b,this.serializeFunctions)-b+1}a[b+3]=(c>>24)&255;a[b+2]=(c>>16)&255;a[b+1]=(c>>8)&255;a[b]=c&255;b=b+c;a[b-1]=0;return a};UpdateCommand.DB_UPSERT=0;UpdateCommand.DB_MULTI_UPDATE=1;