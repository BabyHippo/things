/*
 * Module dependencies.
 */
var EventEmitter=require("events").EventEmitter,ObjectId=require("./types/objectid"),ms=require("ms"),MongooseBuffer,MongooseArray,Document;exports.toCollectionName=function(a){if("system.profile"===a){return a}if("system.indexes"===a){return a}return pluralize(a.toLowerCase())};exports.pluralization=[[/(m)an$/gi,"$1en"],[/(pe)rson$/gi,"$1ople"],[/(child)$/gi,"$1ren"],[/^(ox)$/gi,"$1en"],[/(ax|test)is$/gi,"$1es"],[/(octop|vir)us$/gi,"$1i"],[/(alias|status)$/gi,"$1es"],[/(bu)s$/gi,"$1ses"],[/(buffal|tomat|potat)o$/gi,"$1oes"],[/([ti])um$/gi,"$1a"],[/sis$/gi,"ses"],[/(?:([^f])fe|([lr])f)$/gi,"$1$2ves"],[/(hive)$/gi,"$1s"],[/([^aeiouy]|qu)y$/gi,"$1ies"],[/(x|ch|ss|sh)$/gi,"$1es"],[/(matr|vert|ind)ix|ex$/gi,"$1ices"],[/([m|l])ouse$/gi,"$1ice"],[/(quiz)$/gi,"$1zes"],[/s$/gi,"s"],[/$/gi,"s"]];var rules=exports.pluralization;exports.uncountables=["advice","energy","excretion","digestion","cooperation","health","justice","labour","machinery","equipment","information","pollution","sewage","paper","money","species","series","rain","rice","fish","sheep","moose","deer","news"];var uncountables=exports.uncountables;
/*
 * Pluralize function.
 *
 * @author TJ Holowaychuk (extracted from _ext.js_)
 * @param {String} string to pluralize
 * @api private
 */
function pluralize(c){var b,a;if(!~uncountables.indexOf(c.toLowerCase())){a=rules.filter(function(d){return c.match(d[0])});if(a[0]){return c.replace(a[0][0],a[0][1])}}return c}
/*
 * Add `once` to EventEmitter if absent
 *
 * @param {String} event name
 * @param {Function} listener
 * @api private
 */
var Events=EventEmitter;if(!("once" in EventEmitter.prototype)){Events=function(){EventEmitter.apply(this,arguments)};
/*
   * Inherit from EventEmitter.
   */
Events.prototype.__proto__=EventEmitter.prototype;
/*
   * Add `once`.
   */
Events.prototype.once=function(d,b){var c=this;c.on(d,function a(){c.removeListener(d,a);b.apply(this,arguments)})}}exports.EventEmitter=Events;exports.deepEqual=function deepEqual(c,d){if(c===d){return true}if(c instanceof Date&&d instanceof Date){return c.getTime()===d.getTime()}if(c instanceof ObjectId&&d instanceof ObjectId){return c.toString()===d.toString()}if(typeof c!=="object"&&typeof d!=="object"){return c==d}if(c===null||d===null||c===undefined||d===undefined){return false}if(c.prototype!==d.prototype){return false}if(c instanceof Number&&d instanceof Number){return c.valueOf()===d.valueOf()}if(Buffer.isBuffer(c)){if(!Buffer.isBuffer(d)){return false}if(c.length!==d.length){return false}for(var g=0,l=c.length;g<l;++g){if(c[g]!==d[g]){return false}}return true}if(isMongooseObject(c)){c=c.toObject()}if(isMongooseObject(d)){d=d.toObject()}try{var h=Object.keys(c),j=Object.keys(d),k,g}catch(f){return false}if(h.length!=j.length){return false}h.sort();j.sort();for(g=h.length-1;g>=0;g--){if(h[g]!=j[g]){return false}}for(g=h.length-1;g>=0;g--){k=h[g];if(!deepEqual(c[k],d[k])){return false}}return true};exports.clone=function clone(a,b){if(a===undefined||a===null){return a}if(Array.isArray(a)){return cloneArray(a,b)}if(isMongooseObject(a)){if(b&&b.json&&"function"===typeof a.toJSON){return a.toJSON(b)}else{return a.toObject(b)}}if("Object"===a.constructor.name){return cloneObject(a,b)}if("Date"===a.constructor.name||"Function"===a.constructor.name){return new a.constructor(+a)}if("RegExp"===a.constructor.name){return new RegExp(a.source)}if(a instanceof ObjectId){return new ObjectId(a.id)}if(a.valueOf){return a.valueOf()}};var clone=exports.clone;
/*
 * ignore
 */
function cloneObject(f,g){var j=g&&g.retainKeyOrder,e=g&&g.minimize,h={},a,d,l,c,b;if(j){for(c in f){l=clone(f[c],g);if(!e||("undefined"!==typeof l)){a||(a=true);h[c]=l}}}else{d=Object.keys(f);b=d.length;while(b--){c=d[b];l=clone(f[c],g);if(!e||("undefined"!==typeof l)){if(!a){a=true}h[c]=l}}}return e?a&&h:h}function cloneArray(a,d){var e=[];for(var b=0,c=a.length;b<c;b++){e.push(clone(a[b],d))}return e}exports.options=function(a,e){var d=Object.keys(a),b=d.length,c;e=e||{};while(b--){c=d[b];if(!(c in e)){e[c]=a[c]}}return e};exports.random=function(){return Math.random().toString().substr(3)};
/*
 * TODO remove
 */
exports.inGroupsOf=function inGroupsOf(b,a,c){var d=[];for(var e=0,f=a.length;e<f;e++){if(e&&e%b===0){c.apply(this,d);d.length=0}d.push(a[e])}c.apply(this,d)};exports.merge=function merge(e,a){var d=Object.keys(a),b=d.length,c;while(b--){c=d[b];if("undefined"===typeof e[c]){e[c]=a[c]}else{merge(e[c],a[c])}}};exports.args=function(a,e,f){var d=[];var g=e||0;var b=3===arguments.length?f:a.length;for(var c=g;c<b;++c){d[c-g]=a[c]}return d};exports.tick=function tick(a){if("function"!==typeof a){return}return function(){try{a.apply(this,arguments)}catch(b){process.nextTick(function(){throw b})}}};exports.isMongooseObject=function(a){Document||(Document=require("./document"));MongooseArray||(MongooseArray=require("./types").Array);MongooseBuffer||(MongooseBuffer=require("./types").Buffer);return a instanceof Document||a instanceof MongooseArray||a instanceof MongooseBuffer};var isMongooseObject=exports.isMongooseObject;exports.expires=function expires(a){if(!(a&&"Object"==a.constructor.name)){return}if(!("expires" in a)){return}var b;if("string"!=typeof a.expires){b=a.expires}else{b=Math.round(ms(a.expires)/1000)}a.expiresAfterSeconds=b;delete a.expires};