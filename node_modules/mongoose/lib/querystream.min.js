/*
 * Module dependencies.
 */
var Stream=require("stream").Stream;var utils=require("./utils");function QueryStream(a){Stream.call(this);this.query=a;this.readable=true;this.paused=false;this._cursor=null;this._destroyed=null;this._fields=null;this._ticks=0;this._inline=T_INIT;var b=this;process.nextTick(function(){b._init()})}
/*
 * Inherit from Stream
 */
QueryStream.prototype.__proto__=Stream.prototype;QueryStream.prototype.readable;QueryStream.prototype.paused;var T_INIT=0;var T_IDLE=1;var T_CONT=2;QueryStream.prototype._init=function(){if(this._destroyed){return}var d=this.query,b=d.model,c=d._optionsForExec(b),e=this;try{d.cast(b)}catch(a){return e.destroy(a)}e._fields=utils.clone(c.fields=d._fields);b.collection.find(d._conditions,c,function(g,f){if(g){return e.destroy(g)}e._cursor=f;e._next()})};QueryStream.prototype._next=function(){var a;while(a=this.__next()){a.call(this)}};QueryStream.prototype.__next=function(){if(this.paused||this._destroyed){return}var a=this;a._inline=T_INIT;a._cursor.nextObject(function(c,b){a._onNextObject(c,b)});if(T_CONT===this._inline){return this.__next}else{this._inline=T_IDLE}};QueryStream.prototype._onNextObject=function(b,a){if(b){return this.destroy(b)}if(!a){return this.destroy()}if(this.query.options&&this.query.options.lean===true){this.emit("data",a);this._next();return}var c=new this.query.model(undefined,this._fields);delete c._doc._id;var d=this;c.init(a,this.query,function(e){if(e){return d.destroy(e)}d.emit("data",c);if(T_IDLE===d._inline){d._next()}else{d._inline=T_CONT}})};QueryStream.prototype.pause=function(){this.paused=true};QueryStream.prototype.resume=function(){this.paused=false;this._next()};QueryStream.prototype.destroy=function(a){if(this._destroyed){return}this._destroyed=true;this.readable=false;if(this._cursor){this._cursor.close()}if(a){this.emit("error",a)}this.emit("close")}
/*
 * Module exports
 */
;module.exports=exports=QueryStream;