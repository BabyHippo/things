/*
 * Module dependencies.
 */
var EmbeddedDocument=require("./embedded");var Document=require("../document");var ObjectId=require("./objectid");function MongooseArray(d,c,b){var a=[];a.push.apply(a,d);a.__proto__=MongooseArray.prototype;a._atomics={};a.validators=[];a._path=c;if(b){a._parent=b;a._schema=b.schema.path(c)}return a}
/*
 * Inherit from Array
 */
MongooseArray.prototype=new Array;MongooseArray.prototype._atomics;MongooseArray.prototype._parent;MongooseArray.prototype._cast=function(c){var a=this._schema.caster.cast,b=this._parent;return a.call(null,c,b)};MongooseArray.prototype._markModified=function(b,c){var d=this._parent,a;if(d){if(arguments.length){a=[this._path,this.indexOf(b),c].join(".")}else{a=this._path}d.markModified(a)}return this};MongooseArray.prototype._registerAtomic=function(b,f){if("$set"==b){this._atomics={$set:f};this._markModified();return this}var a=this._atomics;if("$pop"==b&&!("$pop" in a)){var e=this;this._parent.once("save",function(){e._popped=e._shifted=null})}if(this._atomics.$set){return this}if(Object.keys(a).length&&!(b in a)){this._atomics={$set:this};this._markModified();return this}if(b==="$pullAll"||b==="$pushAll"||b==="$addToSet"){a[b]||(a[b]=[]);a[b]=a[b].concat(f)}else{if(b==="$pullDocs"){var c=a["$pull"]||(a["$pull"]={}),d=c._id||(c._id={"$in":[]});d["$in"]=d["$in"].concat(f)}else{a[b]=f}}this._markModified();return this};MongooseArray.prototype.hasAtomics=function hasAtomics(){if(!(this._atomics&&"Object"===this._atomics.constructor.name)){return 0}return Object.keys(this._atomics).length};MongooseArray.prototype.push=function(){var b=[].map.call(arguments,this._cast,this),a=[].push.apply(this,b);this._registerAtomic("$pushAll",b);return a};MongooseArray.prototype.nonAtomicPush=function(){var b=[].map.call(arguments,this._cast,this),a=[].push.apply(this,b);this._registerAtomic("$set",this);return a};MongooseArray.prototype.$pop=function(){this._registerAtomic("$pop",1);if(this._popped){return}this._popped=true;return[].pop.call(this)};MongooseArray.prototype.pop=function(){var a=[].pop.call(this);this._registerAtomic("$set",this);return a};MongooseArray.prototype.$shift=function $shift(){this._registerAtomic("$pop",-1);if(this._shifted){return}this._shifted=true;return[].shift.call(this)};MongooseArray.prototype.shift=function(){var a=[].shift.call(this);this._registerAtomic("$set",this);return a};MongooseArray.prototype.remove=function(){var a=[].map.call(arguments,this._cast,this);if(a.length==1){this.pull(a[0])}else{this.pull.apply(this,a)}return a};MongooseArray.prototype.pull=function(){var d=[].map.call(arguments,this._cast,this),a=this._parent.get(this._path),b=a.length,c;while(b--){c=a[b];if(c instanceof EmbeddedDocument){if(d.some(function(e){return e.equals(c)})){[].splice.call(a,b,1)}}else{if(~a.indexOf.call(d,c)){[].splice.call(a,b,1)}}}if(d[0] instanceof EmbeddedDocument){this._registerAtomic("$pullDocs",d.map(function(e){return e._id}))}else{this._registerAtomic("$pullAll",d)}return this};MongooseArray.prototype.splice=function(){if(arguments.length){var a=[].splice.apply(this,arguments);this._registerAtomic("$set",this)}return a};MongooseArray.prototype.unshift=function(){var a=[].map.call(arguments,this._cast,this);[].unshift.apply(this,a);this._registerAtomic("$set",this);return this.length};MongooseArray.prototype.sort=function(){var a=[].sort.apply(this,arguments);this._registerAtomic("$set",this);return a};MongooseArray.prototype.addToSet=function addToSet(){var c=[].map.call(arguments,this._cast,this),a=[],b=c[0] instanceof EmbeddedDocument?"doc":c[0] instanceof Date?"date":"";c.forEach(function(e){var d;switch(b){case"doc":d=this.some(function(g){return g.equals(e)});break;case"date":var f=+e;d=this.some(function(g){return +g===f});break;default:d=~this.indexOf(e)}if(!d){[].push.call(this,e);this._registerAtomic("$addToSet",e);[].push.call(a,e)}},this);return a};MongooseArray.prototype.toObject=function(a){if(a&&a.depopulate&&this[0] instanceof Document){return this.map(function(b){return b._id})}return this.map(function(b){return b})};MongooseArray.prototype.inspect=function(){return"["+this.map(function(a){return" "+a})+" ]"};MongooseArray.prototype.indexOf=function indexOf(c){if(c instanceof ObjectId){c=c.toString()}for(var a=0,b=this.length;a<b;++a){if(c==this[a]){return a}}return -1};
/*
 * Module exports.
 */
module.exports=exports=MongooseArray;