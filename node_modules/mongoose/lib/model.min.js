/*
 * Module dependencies.
 */
var Document=require("./document"),MongooseArray=require("./types/array"),MongooseBuffer=require("./types/buffer"),MongooseError=require("./error"),Query=require("./query"),Schema=require("./schema"),utils=require("./utils"),isMongooseObject=utils.isMongooseObject,EventEmitter=utils.EventEmitter,merge=utils.merge,Promise=require("./promise"),tick=utils.tick;var VERSION_WHERE=1,VERSION_INC=2,VERSION_ALL=VERSION_WHERE|VERSION_INC;function Model(a,b,c){Document.call(this,a,b,c)}
/*
 * Inherits from Document.
 */
Model.prototype.__proto__=Document.prototype;Model.prototype.db;Model.prototype.collection;Model.prototype.modelName;Model.prototype._getPopulationKeys=function getPopulationKeys(k){if(!(k&&k.options.populate)){return}var e=Object.keys(k.options.populate),c=e.length,d,g={},a,l;while(c--){d=e[c];l=this.schema.path(d);a=true;if(!l){var j=d.split("."),b=j.length;while(b--){var f=j.slice(0,b).join("."),h=this.schema.path(f);if(h&&h.caster){if(!g[f]){g[f]={sub:{}}}g[f].sub[j.slice(b).join(".")]=k.options.populate[d];a||(a=true);break}}}else{g[d]=k.options.populate[d];a||(a=true)}}return a&&g};Model.prototype._populate=function populate(f,d,e,b){if(!Array.isArray(d)){var a=e.conditions||{};a._id=d;return this.db.model(e.model||f.options.ref).findOne(a,e.fields,e.options,b)}if(!d.length){return b(null,d)}var c=this.db.model(e.model||f.caster.options.ref),a=e&&e.conditions||{};a._id||(a._id={$in:d});c.find(a,e.fields,e.options,function(k,j){if(k){return b(k)}if(e.options&&e.options.sort){return b(null,j)}var h={};j.forEach(function(l){h[l._id]=l});var g=[];d.forEach(function(l){if(l in h){g.push(h[l])}});b(null,g)})};Model.prototype.init=function init(a,f,c){if("function"==typeof f){c=f;f=null}var e=this._getPopulationKeys(f);if(!e){return Document.prototype.init.call(this,a,c)}var g=this;d(a,"",function(h){if(h){return c(h)}Document.prototype.init.call(g,a,c)});return this;function d(m,n,h){n=n||"";var j=Object.keys(m),k=j.length;function l(){if(--k<0){return h()}var o=j[k],p=n+o,r=g.schema.path(p),s=0,q;if(!r&&m[o]&&"Object"===m[o].constructor.name){return d(m[o],p+".",l)}if(!(m[o]&&r&&e[p])){return l()}q=utils.clone(e[p]);if(q.sub){m[o].forEach(function(w){var v=Object.keys(q.sub),u=v.length,t;while(u--){t=v[u];if(w[t]){(function(y){s++;g._populate(r.schema.path(y),w[y],q.sub[y],x);function x(A,z){if(A){return b(A)}w[y]=z;--s||l()}})(t)}}});if(0===s){return l()}}else{g._populate(r,m[o],q,function(u,t){if(u){return b(u)}m[o]=t;l()})}}l()}function b(h){if(b.err){return}c(b.err=h)}};
/*
 * Handles doc.save() callbacks
 */
function handleSave(b,c){return tick(function a(e,h){if(e){if(c._inserting){c.isNew=true;c.emit("isNew",true)}b.error(e);b=c=null;return}c._storeShard();var g;if(h){g=h.length?h.length:h}else{g=0}if(c.__version&&!c._inserting){var d=VERSION_INC===(VERSION_INC&c.__version);c.__version=undefined;if(g>0){if(d){var f=c.schema.options.versionKey;var j=c.getValue(f)|0;c.setValue(f,j+1)}}else{b.error(new Error("No matching document found."));b=c=null;return}}c.emit("save",c,g);b.complete(c,g);b=c=null})}Model.prototype.save=function save(c){var f=new Promise(c),a=handleSave(f,this),e={};if(this.schema.options.safe){e.safe=this.schema.options.safe}if(this.isNew){var d=this.toObject({depopulate:1});this._version(true,d);this.collection.insert(d,e,a);this._reset();this.isNew=false;this.emit("isNew",false);this._inserting=true}else{this._inserting=false;var b=this._delta();if(b){var g=this._where(b[0]);this.collection.update(g,b[1],e,a)}else{a(null)}this._reset();this.emit("isNew",false)}};
/*
 * Apply the operation to the delta (update) clause as
 * well as track versioning for our where clause.
 *
 * @param {Document} self
 * @param {Object} where
 * @param {Object} delta
 * @param {Object} data
 * @param {Mixed} val
 * @param {String} [operation]
 */
function operand(d,f,b,a,e,c){c||(c="$set");if(!b[c]){b[c]={}}b[c][a.path]=e;if(false===d.schema.options.versionKey){return}if(VERSION_ALL===(VERSION_ALL&d.__version)){return}switch(c){case"$set":case"$unset":case"$pop":case"$pull":case"$pullAll":case"$push":case"$pushAll":case"$addToSet":break;default:return}if("$push"==c||"$pushAll"==c||"$addToSet"==c){d.__version=VERSION_INC}else{if(/^\$p/.test(c)){d.increment()}else{if(Array.isArray(e)){d.increment()}else{if(/\.\d+/.test(a.path)){d.__version=VERSION_WHERE}}}}}
/*
 * Compiles an update and where clause for an array.
 *
 * @param {Document} self
 * @param {Object} where
 * @param {Object} delta
 * @param {Object} data
 * @param {Array} arr
 */
function handleMongooseArray(k,m,d,c,a){if(d.$set&&d.$set[c.path]){return}var b=a._atomics,g=Object.keys(b),j=c.schema,h=c.path,e=g.length,l,f;if(0===e){a=a.toObject({depopulate:1});return operand(k,m,d,c,a)}while(e--){f=g[e];l=b[f];if(isMongooseObject(l)){l=l.toObject({depopulate:1})}else{if(Array.isArray(l)){l=l.map(function(n){return isMongooseObject(n)?n.toObject({depopulate:1}):n})}}if("$addToSet"===f){l={$each:l}}operand(k,m,d,c,l,f)}}Model.prototype._delta=function _delta(){var e=this._dirty();if(!e.length){return}var j=this,m={},c={},f=e.length,a=0,k,g;for(;a<f;++a){var b=e[a];var l=b.value;var h=b.schema;if(undefined===l){operand(j,m,c,b,1,"$unset")}else{if(null===l){operand(j,m,c,b,null)}else{if(l._path&&l._registerAtomic){handleMongooseArray(j,m,c,b,l)}else{if(l._path&&l.write&&l.toObject){l=l.toObject();operand(j,m,c,b,l)}else{l=utils.clone(l);operand(j,m,c,b,l)}}}}}if(this.__version){this._version(m,c)}return[m,c]};Model.prototype._version=function _version(c,a){var b=this.schema.options.versionKey;if(true===c){if(b){this.setValue(b,a[b]=0)}return}if(!this.isSelected(b)){return}if(VERSION_WHERE===(VERSION_WHERE&this.__version)){c[b]=this.getValue(b)}if(VERSION_INC===(VERSION_INC&this.__version)){a.$inc||(a.$inc={});a.$inc[b]=1}};Model.prototype.increment=function increment(){this.__version=VERSION_ALL;return this};Model.prototype._where=function _where(d){d||(d={});var c,b;if(this._shardval){c=Object.keys(this._shardval);b=c.length;for(var a=0;a<b;++a){d[c[a]]=this._shardval[c[a]]}}d._id=this._doc._id;return d};Model.prototype.remove=function remove(a){if(this._removing){return this}var c=this._removing=new Promise(a),e=this._where(),d=this,b={};if(this.schema.options.safe){b.safe=this.schema.options.safe}this.collection.remove(e,b,tick(function(f){if(f){c.error(f);c=d=d._removing=e=b=null;return}c.complete();d.emit("remove",d);c=d=e=b=null}));return this};Model.prototype._registerHooks=function registerHooks(){Document.prototype._registerHooks.call(this)};Model.prototype.model=function model(a){return this.db.model(a)};
/*
 * Give the constructor the ability to emit events.
 * @TODO determine if this is still necessary
 */
for(var i in EventEmitter.prototype){Model[i]=EventEmitter.prototype[i]}Model.init=function init(){if(this.schema.options.autoIndex){this.ensureIndexes()}this.schema.emit("init",this)};Model.ensureIndexes=function ensureIndexes(a){var d=this.schema.indexes();if(!d.length){return a&&a()}var f=this,e=f.schema.options.safe,b=d.length,c;d.forEach(function(g){var h=g[1];h.safe=e;f.collection.ensureIndex(g[0],h,tick(function(j){if(j){c=j}if(--b){return}f.emit("index",c);a&&a(c)}))})};Model.schema;Model.db;Model.collection;Model.base;Model.remove=function remove(b,a){if("function"===typeof b){a=b;b={}}var c=new Query(b).bind(this,"remove");if("undefined"===typeof a){return c}this._applyNamedScope(c);return c.remove(a)};Model.find=function find(b,c,d,a){if("function"==typeof b){a=b;b={};c=null;d=null}else{if("function"==typeof c){a=c;c=null;d=null}else{if("function"==typeof d){a=d;d=null}}}var e=new Query(b,d);e.bind(this,"find");e.select(c);if("undefined"===typeof a){return e}this._applyNamedScope(e);return e.find(a)};Model._applyNamedScope=function _applyNamedScope(b){var a=this._cumulativeQuery;if(a){merge(b._conditions,a._conditions);if(b._fields&&a._fields){merge(b._fields,a._fields)}if(b.options&&a.options){merge(b.options,a.options)}delete this._cumulativeQuery}return b};Model.findById=function findById(c,b,d,a){return this.findOne({_id:c},b,d,a)};Model.findOne=function findOne(b,c,d,a){if("function"==typeof d){a=d;d=null}else{if("function"==typeof c){a=c;c=null;d=null}else{if("function"==typeof b){a=b;b={};c=null;d=null}}}var e=new Query(b,d).select(c).bind(this,"findOne");if("undefined"==typeof a){return e}this._applyNamedScope(e);return e.findOne(a)};Model.count=function count(b,a){if("function"===typeof b){a=b,b={}}var c=new Query(b).bind(this,"count");if("undefined"==typeof a){return c}this._applyNamedScope(c);return c.count(a)};Model.distinct=function distinct(c,b,a){var d=new Query(b).bind(this,"distinct");if("undefined"==typeof a){d._distinctArg=c;return d}this._applyNamedScope(d);return d.distinct(c,a)};Model.where=function where(a,c){var b=new Query().bind(this,"find");return b.where.apply(b,arguments)};Model.$where=function $where(){var a=new Query().bind(this,"find");return a.$where.apply(a,arguments)};Model.findOneAndUpdate=function(b,g,e,a){if("function"==typeof e){a=e;e=null}else{if(1===arguments.length){if("function"==typeof b){var d="Model.findOneAndUpdate(): First argument must not be a function.\n\n  "+this.modelName+".findOneAndUpdate(conditions, update, options, callback)\n  "+this.modelName+".findOneAndUpdate(conditions, update, options)\n  "+this.modelName+".findOneAndUpdate(conditions, update)\n  "+this.modelName+".findOneAndUpdate(update)\n  "+this.modelName+".findOneAndUpdate()\n";throw new TypeError(d)}g=b;b=undefined}}var c;if(e&&e.fields){c=e.fields;e.fields=undefined}var f=new Query(b,e);f.select(c);f.bind(this,"findOneAndUpdate",g);if("undefined"==typeof a){return f}this._applyNamedScope(f);return f.findOneAndUpdate(a)};Model.findByIdAndUpdate=function(c,f,e,b){var a;if(1===arguments.length){if("function"==typeof c){var d="Model.findByIdAndUpdate(): First argument must not be a function.\n\n  "+this.modelName+".findByIdAndUpdate(id, callback)\n  "+this.modelName+".findByIdAndUpdate(id)\n  "+this.modelName+".findByIdAndUpdate()\n";throw new TypeError(d)}return this.findOneAndUpdate({_id:c},undefined)}a=utils.args(arguments,1);a.unshift({_id:c});return this.findOneAndUpdate.apply(this,a)};Model.findOneAndRemove=function(b,e,a){if(1===arguments.length&&"function"==typeof b){var d="Model.findOneAndRemove(): First argument must not be a function.\n\n  "+this.modelName+".findOneAndRemove(conditions, callback)\n  "+this.modelName+".findOneAndRemove(conditions)\n  "+this.modelName+".findOneAndRemove()\n";throw new TypeError(d)}if("function"==typeof e){a=e;e=undefined}var c;if(e){c=e.select;e.select=undefined}var f=new Query(b,e);f.bind(this,"findOneAndRemove");f.select(c);if("undefined"==typeof a){return f}this._applyNamedScope(f);return f.findOneAndRemove(a)};Model.findByIdAndRemove=function(b,d,a){if(1===arguments.length&&"function"==typeof b){var c="Model.findByIdAndRemove(): First argument must not be a function.\n\n  "+this.modelName+".findByIdAndRemove(id, callback)\n  "+this.modelName+".findByIdAndRemove(id)\n  "+this.modelName+".findByIdAndRemove()\n";throw new TypeError(c)}return this.findOneAndRemove({_id:b},d,a)};Model.create=function create(c,e){if(1===arguments.length){return"function"===typeof c&&c(null)}var g=this,d=[null],f,b,a;if(Array.isArray(c)){a=c}else{a=utils.args(arguments,0,arguments.length-1);e=arguments[arguments.length-1]}if(0===a.length){return e(null)}f=new Promise(e);b=a.length;a.forEach(function(h,k){var j=new g(h);d[k+1]=j;j.save(function(l){if(l){return f.error(l)}--b||e.apply(null,d)})})};Model.update=function update(b,c,d,a){if(arguments.length<4){if("function"===typeof d){a=d;d=null}else{if("function"===typeof c){a=c;c=b;b={};d=null}}}var e=new Query(b,d).bind(this,"update",c);if("undefined"==typeof a){return e}this._applyNamedScope(e);return e.update(c,a)};Model.mapReduce=function mapReduce(b,a){if("function"!=typeof a){throw new Error("missing callback")}var d=this;if(!Model.mapReduce.schema){var c={noId:true,noVirtualId:true,strict:false};Model.mapReduce.schema=new Schema({},c)}if(!b.out){b.out={inline:1}}b.map=String(b.map);b.reduce=String(b.reduce);this.collection.mapReduce(null,null,b,function(e,g,h){if(e){return a(e)}if(g.findOne&&g.mapReduce){var f=Model.compile("_mapreduce_"+g.collectionName,Model.mapReduce.schema,g.collectionName,d.db,d.base);f._mapreduce=true;return a(e,f,h)}a(e,g,h)})}
/*
 * Compiler utility.
 *
 * @param {String} name model name
 * @param {Schema} schema
 * @param {String} collectionName
 * @param {Connection} connection
 * @param {Mongoose} base mongoose instance
 */
;Model.compile=function compile(f,g,b,c,a){function e(h,j,k){if(!(this instanceof e)){return new e(h,j,k)}Model.call(this,h,j,k)}e.modelName=f;e.__proto__=Model;e.prototype.__proto__=Model.prototype;e.prototype.db=c;e.prototype._setSchema(g);e.prototype.collection=c.collection(b,g.options.capped);for(var d in g.methods){e.prototype[d]=g.methods[d]}for(var d in g.statics){e[d]=g.statics[d]}if(g.namedScopes){g.namedScopes.compile(e)}e.model=e.prototype.model;e.options=e.prototype.options;e.db=e.prototype.db;e.schema=e.prototype.schema;e.collection=e.prototype.collection;e.base=a;return e};
/*
 * Module exports.
 */
module.exports=exports=Model;