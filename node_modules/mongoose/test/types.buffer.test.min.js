var start=require("./common"),assert=require("assert"),mongoose=require("./common").mongoose,Schema=mongoose.Schema,random=require("../lib/utils").random,MongooseBuffer=mongoose.Types.Buffer;function valid(a){return !a||a.length>10}var subBuf=new Schema({name:String,buf:{type:Buffer,validate:[valid,"valid failed"],required:true}});var UserBuffer=new Schema({name:String,serial:Buffer,array:[Buffer],required:{type:Buffer,required:true,index:true},sub:[subBuf]});describe("types.buffer",function(){it("test that a mongoose buffer behaves and quacks like an buffer",function(){var d=new MongooseBuffer;assert.ok(d instanceof Buffer);assert.ok(d instanceof MongooseBuffer);assert.equal(true,Buffer.isBuffer(d));var d=new MongooseBuffer([195,188,98,101,114]);var e=new MongooseBuffer("buffer shtuffs are neat");var f=new MongooseBuffer("aGVsbG8gd29ybGQ=","base64");assert.equal(d.toString("utf8"),"Ã¼ber");assert.equal(e.toString("utf8"),"buffer shtuffs are neat");assert.equal(f.toString("utf8"),"hello world")});it("buffer validation",function(b){var a=start(),c=a.model("UserBuffer",UserBuffer,"usersbuffer_"+random());c.on("index",function(){var d=new c({name:"test validation"});d.validate(function(e){assert.equal(e.message,"Validation failed");assert.equal(e.errors.required.type,"required");d.required=20;d.save(function(f){assert.equal(f.name,"CastError");assert.equal(f.type,"buffer");assert.equal(f.value,20);assert.equal(f.message,'Cast to buffer failed for value "20"');d.required=new Buffer("hello");d.sub.push({name:"Friday Friday"});d.save(function(g){assert.equal(g.message,"Validation failed");assert.equal(g.errors["sub.0.buf"].type,"required");d.sub[0].buf=new Buffer("well well");d.save(function(h){assert.equal(h.message,"Validation failed");assert.equal(h.errors["sub.0.buf"].type,"valid failed");d.sub[0].buf=new Buffer("well well well");d.validate(function(i){a.close();assert.ifError(i);b()})})})})})})});it("buffer storage",function(b){var a=start(),c=a.model("UserBuffer",UserBuffer,"usersbuffer_"+random());c.on("index",function(){var d=new Buffer([123,223,23,42,11]);var e=new c({name:"tj",serial:d,required:new Buffer(d)});e.save(function(f){assert.ifError(f);c.find({},function(h,j){a.close();assert.ifError(h);assert.equal(j.length,1);var i=j[0];var g=d.toString("base64");assert.equal(g,i.serial.toString("base64"),"buffer mismatch");assert.equal(g,i.required.toString("base64"),"buffer mismatch");b()})})})});it("test write markModified",function(b){var a=start(),d=a.model("UserBuffer",UserBuffer,"usersbuffer_"+random());d.on("index",function(){var e=new Buffer([123,223,23,42,11]);var f=new d({name:"tj",serial:e,required:e});f.save(function(g){assert.ifError(g);f.serial.write("aa",1,"ascii");assert.equal(true,f.isModified("serial"));f.save(function(h){assert.ifError(h);d.findById(f._id,function(j,r){a.close();assert.ifError(j);var k=new Buffer([123,97,97,42,11]);assert.equal(k.toString("base64"),r.serial.toString("base64"),"buffer mismatch");assert.equal(false,f.isModified("required"));f.serial.copy(f.required,1);assert.equal(true,f.isModified("required"));assert.equal("e3thYSo=",f.required.toString("base64"));function q(i){assert.equal(false,i.isModified("required"))}function n(i){assert.equal(true,i.isModified("required"))}var l={writeUInt8:function(){c(f);q(f);f.required.writeUInt8(3,0,"big");n(f)},writeUInt16:function(){c(f);q(f);f.required.writeUInt16(48879,0,"little");n(f)},writeUInt16LE:function(){c(f);q(f);f.required.writeUInt16LE(48879,0);n(f)},writeUInt16BE:function(){c(f);q(f);f.required.writeUInt16BE(48879,0);n(f)},writeUInt32:function(){c(f);q(f);f.required.writeUInt32(4277009102,0,"little");n(f)},writeUInt32LE:function(){c(f);q(f);f.required.writeUInt32LE(4277009102,0);n(f)},writeUInt32BE:function(){c(f);q(f);f.required.writeUInt32BE(4277009102,0);n(f)},writeInt8:function(){c(f);q(f);f.required.writeInt8(-5,0,"big");n(f)},writeInt16:function(){c(f);q(f);f.required.writeInt16(35,2,"little");n(f);assert.equal(f.required[2],35);assert.equal(f.required[3],0)},writeInt16LE:function(){c(f);q(f);f.required.writeInt16LE(35,2);n(f);assert.equal(f.required[2],35);assert.equal(f.required[3],0)},writeInt16BE:function(){c(f);q(f);f.required.writeInt16BE(35,2);n(f)},writeInt32:function(){c(f);q(f);f.required.writeInt32(35,0,"big");n(f);assert.equal(f.required[0],0);assert.equal(f.required[1],0);assert.equal(f.required[2],0);assert.equal(f.required[3],35);f.required=new Buffer(8)},writeInt32LE:function(){f.required=new Buffer(8);c(f);q(f);f.required.writeInt32LE(35,0);n(f)},writeInt32BE:function(){f.required=new Buffer(8);c(f);q(f);f.required.writeInt32BE(35,0);n(f);assert.equal(f.required[0],0);assert.equal(f.required[1],0);assert.equal(f.required[2],0);assert.equal(f.required[3],35)},writeFloat:function(){f.required=new Buffer(16);c(f);q(f);f.required.writeFloat(2.225073858507201e-308,0,"big");n(f);assert.equal(f.required[0],0);assert.equal(f.required[1],15);assert.equal(f.required[2],255);assert.equal(f.required[3],255);assert.equal(f.required[4],255);assert.equal(f.required[5],255);assert.equal(f.required[6],255);assert.equal(f.required[7],255)},writeFloatLE:function(){f.required=new Buffer(16);c(f);q(f);f.required.writeFloatLE(2.225073858507201e-308,0);n(f)},writeFloatBE:function(){f.required=new Buffer(16);c(f);q(f);f.required.writeFloatBE(2.225073858507201e-308,0);n(f)},writeDoubleLE:function(){f.required=new Buffer(8);c(f);q(f);f.required.writeDoubleLE(1.60456909845031e+19,0);n(f)},writeDoubleBE:function(){f.required=new Buffer(8);c(f);q(f);f.required.writeDoubleBE(1.60456909845031e+19,0);n(f)},fill:function(){f.required=new Buffer(8);c(f);q(f);f.required.fill(0);n(f);for(var s=0;s<f.required.length;s++){assert.strictEqual(f.required[s],0)}},set:function(){c(f);q(f);f.required.set(0,1);n(f)}};var p=Object.keys(l),m=p.length,o;while(m--){o=p[m];if(Buffer.prototype[o]){l[o]()}}b()})})})});function c(e){e._activePaths.clear("modify");e.schema.requiredPaths().forEach(function(f){e._activePaths.require(f)})}})});