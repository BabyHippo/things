var assert=require("assert"),start=require("./common"),mongoose=start.mongoose,EmbeddedDocument=require("../lib/types/embedded"),DocumentArray=require("../lib/types/documentarray"),Schema=mongoose.Schema,SchemaType=mongoose.SchemaType,ValidatorError=SchemaType.ValidatorError,ValidationError=mongoose.Document.ValidationError;function Dummy(){mongoose.Document.call(this,{})}Dummy.prototype.__proto__=mongoose.Document.prototype;Dummy.prototype._setSchema(new Schema);function Subdocument(){var a=new DocumentArray;a._path="jsconf.ar";a._parent=new Dummy;a[0]=this;EmbeddedDocument.call(this,{},a)}Subdocument.prototype.__proto__=EmbeddedDocument.prototype;Subdocument.prototype._setSchema(new Schema({test:{type:String,required:true},work:{type:String,validate:/^good/}}));var RatingSchema=new Schema({stars:Number});var MovieSchema=new Schema({title:String,ratings:[RatingSchema]});mongoose.model("Movie",MovieSchema);describe("types.document",function(){it("test that save fires errors",function(c){var b=new Subdocument();b.set("test","");b.set("work","nope");b.save(function(a){assert.ok(b.__parent._validationError instanceof ValidationError);assert.equal(b.__parent.errors["jsconf.ar.0.work"].name,"ValidatorError");assert.equal(b.__parent._validationError.toString(),'ValidationError: Validator "required" failed for path test, Validator failed for path work');c()})});it("objects can be passed to #set",function(){var b=new Subdocument();b.set({test:"paradiddle",work:"good flam"});assert.equal(b.test,"paradiddle");assert.equal(b.work,"good flam")});it("Subdocuments can be passed to #set",function(){var c=new Subdocument();c.set({test:"paradiddle",work:"good flam"});assert.equal(c.test,"paradiddle");assert.equal(c.work,"good flam");var d=new Subdocument();d.set(c);assert.equal(d.test,"paradiddle");assert.equal(d.work,"good flam")});it("cached _ids",function(){var a=start();var d=a.model("Movie");a.close();var b=new d;assert.equal(b.id,b.__id);var e=b.id;b._id=new mongoose.Types.ObjectId;assert.equal(b.id,b.__id);assert.strictEqual(true,e!==b.__id);var c=new d;delete c._doc._id;c.init({_id:new mongoose.Types.ObjectId});assert.equal(c.id,c.__id);assert.strictEqual(true,b.__id!==c.__id);assert.strictEqual(true,b.id!==c.id);assert.strictEqual(true,b.__id!==c.__id)});it("Subdocument#remove (gh-531)",function(b){var a=start();var g=a.model("Movie");var h=new g({title:"Super 8"});var c="4e3d5fc7da5d7eb635063c96";var d="4e3d5fc7da5d7eb635063c97";var e="4e3d5fc7da5d7eb635063c98";var f="4e3d5fc7da5d7eb635063c99";h.ratings.push({stars:9,_id:c});h.ratings.push({stars:8,_id:d});h.ratings.push({stars:7,_id:e});h.ratings.push({stars:6,_id:f});h.save(function(i){assert.ifError(i);assert.equal(h.title,"Super 8");assert.equal(h.ratings.id(c).stars.valueOf(),9);assert.equal(h.ratings.id(d).stars.valueOf(),8);assert.equal(h.ratings.id(e).stars.valueOf(),7);assert.equal(h.ratings.id(f).stars.valueOf(),6);h.ratings.id(c).stars=5;h.ratings.id(d).remove();h.ratings.id(e).stars=4;h.ratings.id(f).stars=3;h.save(function(j){assert.ifError(j);g.findById(h._id,function(k,l){assert.ifError(k);assert.equal(l.title,"Super 8");assert.equal(l.ratings.length,3);assert.equal(l.ratings.id(c).stars.valueOf(),5);assert.equal(l.ratings.id(e).stars.valueOf(),4);assert.equal(l.ratings.id(f).stars.valueOf(),3);l.ratings.id(c).stars=2;l.ratings.id(e).remove();l.ratings.id(f).stars=1;l.save(function(m){assert.ifError(m);g.findById(h._id,function(n,o){assert.ifError(n);assert.equal(o.ratings.length,2);assert.equal(o.ratings.id(c).stars.valueOf(),2);assert.equal(o.ratings.id(f).stars.valueOf(),1);o.ratings[0].remove();o.ratings[0].remove();o.save(function(p){g.findById(h._id,function(q,r){a.close();assert.ifError(q);assert.equal(0,r.ratings.length);b()})})})})})})})})});